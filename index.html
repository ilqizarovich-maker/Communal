<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет коммунальных платежей</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            background-color: var(--dark-color);
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        
        .badge-paid {
            background-color: var(--secondary-color);
        }
        
        .badge-unpaid {
            background-color: var(--danger-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        .tenant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eaeaea;
            border-radius: 5px;
        }
        
        .form-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
        }
        
        .backup-section {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
        }
        
        .user-info {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
        }
        
        .auth-loading {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        @media print {
            .sidebar, .btn-toolbar, .action-buttons {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Экран аутентификации -->
    <div id="auth-screen" class="container">
        <div class="auth-container">
            <div class="card">
                <div class="card-header text-center">
                    <h4>Учет коммунальных платежей</h4>
                    <p class="mb-0">Войдите в систему</p>
                </div>
                <div class="card-body">
                    <div id="auth-error" class="alert alert-danger d-none" role="alert"></div>
                    <div id="auth-loading" class="auth-loading text-center mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Проверка авторизации...</p>
                    </div>
                    <form id="auth-form">
                        <div class="mb-3">
                            <label for="auth-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="auth-password" class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="login-btn">Войти</button>
                            <button type="button" class="btn btn-outline-primary" id="register-btn">Зарегистрироваться</button>
                        </div>
                    </form>
                    <div class="mt-3 text-center">
                        <button type="button" class="btn btn-link p-0" id="offline-mode-btn">Продолжить без входа</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="app-screen" class="container-fluid" style="display: none;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar d-md-block">
                <div class="position-sticky">
                    <h4 class="text-center mb-4">Учет коммунальных платежей</h4>
                    
                    <!-- Информация о пользователе -->
                    <div class="user-info">
                        <div class="d-flex align-items-center">
                            <div class="tenant-avatar" id="user-avatar">U</div>
                            <div>
                                <div id="user-email" class="small">user@example.com</div>
                                <button class="btn btn-sm btn-outline-light mt-1" id="logout-btn">Выйти</button>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="nav flex-column mt-3">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="bi bi-speedometer2"></i> Панель управления
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="properties">
                                <i class="bi bi-building"></i> Объекты недвижимости
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="tenants">
                                <i class="bi bi-people"></i> Арендаторы
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="meter-readings">
                                <i class="bi bi-lightning-charge"></i> Показания счетчиков
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="billing">
                                <i class="bi bi-calculator"></i> Расчет платежей
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="payments">
                                <i class="bi bi-cash-coin"></i> Платежи
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="reports">
                                <i class="bi bi-graph-up"></i> Отчеты
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="settings">
                                <i class="bi bi-gear"></i> Настройки
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="page-section active">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Панель управления</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportDashboardBtn">Экспорт</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printDashboardBtn">Печать</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                                <i class="bi bi-plus-circle"></i> Добавить платеж
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="bi bi-currency-dollar text-primary" style="font-size: 2rem;"></i>
                                    <div class="value text-primary" id="totalPayments">0 ₽</div>
                                    <div class="label">Общая сумма платежей</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="bi bi-lightning-charge text-warning" style="font-size: 2rem;"></i>
                                    <div class="value text-warning" id="totalElectricity">0 кВт/ч</div>
                                    <div class="label">Потребление электроэнергии</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="bi bi-droplet text-info" style="font-size: 2rem;"></i>
                                    <div class="value text-info" id="totalGas">0 м³</div>
                                    <div class="label">Потребление газа</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <div class="value text-success" id="paidPercentage">0%</div>
                                    <div class="label">Оплаченные счета</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    Годовой график платежей
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="yearlyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    Статус оплаты
                                </div>
                                <div class="card-body">
                                    <canvas id="paymentStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Последние платежи</span>
                                    <a href="#" class="btn btn-sm btn-outline-primary" id="showAllPayments">Показать все</a>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Арендатор</th>
                                                    <th>Период</th>
                                                    <th>Начислено</th>
                                                    <th>Оплачено</th>
                                                    <th>Долг</th>
                                                    <th>Статус</th>
                                                    <th>Дата оплаты</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentsTableBody">
                                                <!-- Данные будут заполнены через JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Properties Section -->
                <div id="properties" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Объекты недвижимости</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportPropertiesBtn">Экспорт</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printPropertiesBtn">Печать</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPropertyModal">
                                <i class="bi bi-plus-circle"></i> Добавить объект
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            Список объектов недвижимости
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th>Адрес</th>
                                            <th>Общая площадь, м²</th>
                                            <th>Кол-во арендаторов</th>
                                            <th>Общее потребление э/э</th>
                                            <th>Общее потребление газа</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="propertiesTableBody">
                                        <!-- Данные будут заполнены через JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section с добавленными функциями -->
                <div id="settings" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Настройки</h1>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            Тарифы на коммунальные услуги
                        </div>
                        <div class="card-body">
                            <form id="tariffsForm">
                                <div class="form-section">
                                    <h5 class="form-section-title">Электроэнергия</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="electricityRate" class="form-label">Тариф за кВт/ч (₽)</label>
                                                <input type="number" step="0.01" class="form-control" id="electricityRate" value="5.20">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="electricityNorm" class="form-label">Норматив (кВт/ч на м²)</label>
                                                <input type="number" step="0.01" class="form-control" id="electricityNorm" value="0.5">
                                                <div class="form-text">Используется при отсутствии счетчиков</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h5 class="form-section-title">Газоснабжение</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="gasRate" class="form-label">Тариф за м³ (₽)</label>
                                                <input type="number" step="0.01" class="form-control" id="gasRate" value="7.50">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="gasDistribution" class="form-label">Распределение по</label>
                                                <select class="form-select" id="gasDistribution">
                                                    <option value="area">Площади</option>
                                                    <option value="manual">Индивидуальные счетчики</option>
                                                    <option value="property">Объекту недвижимости</option>
                                                </select>
                                                <div class="form-text">При распределении по площади введите общее потребление газа в расчете платежей</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h5 class="form-section-title">Водоснабжение</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="waterRate" class="form-label">Тариф за м³ (₽)</label>
                                                <input type="number" step="0.01" class="form-control" id="waterRate" value="45.00">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h5 class="form-section-title">Прочие услуги</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="garbageRate" class="form-label">Вывоз мусора (₽/мес)</label>
                                                <input type="number" step="0.01" class="form-control" id="garbageRate" value="350.00">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maintenanceRate" class="form-label">Обслуживание (₽/м²)</label>
                                                <input type="number" step="0.01" class="form-control" id="maintenanceRate" value="25.00">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-primary" id="saveTariffs">Сохранить тарифы</button>
                            </form>
                        </div>
                    </div>

                    <!-- Новый раздел для управления данными -->
                    <div class="card mt-4">
                        <div class="card-header">
                            Управление данными
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-section backup-section">
                                        <h5 class="form-section-title">Резервное копирование</h5>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-success w-100 mb-2" id="createBackupBtn">
                                                <i class="bi bi-cloud-arrow-down"></i> Создать резервную копию
                                            </button>
                                            <button type="button" class="btn btn-outline-success w-100" id="restoreBackupBtn">
                                                <i class="bi bi-cloud-arrow-up"></i> Восстановить из копии
                                            </button>
                                            <input type="file" id="backupFileInput" accept=".json" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-section backup-section">
                                        <h5 class="form-section-title">Очистка данных</h5>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-danger w-100" id="clearDataBtn">
                                                <i class="bi bi-trash"></i> Очистить все данные
                                            </button>
                                            <div class="form-text text-danger">
                                                Внимание: это действие невозможно отменить. Все данные будут удалены безвозвратно.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Статус синхронизации -->
                            <div class="mt-4 p-3 bg-light rounded">
                                <h6>Статус синхронизации</h6>
                                <div id="sync-status" class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status" id="sync-spinner" style="display: none;">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                    <span id="sync-status-text">Не синхронизировано</span>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="sync-now-btn">
                                        <i class="bi bi-arrow-repeat"></i> Синхронизировать сейчас
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Остальные секции (tenants, meter-readings, billing, payments, reports) -->
                <!-- Tenants Section -->
                <div id="tenants" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Арендаторы</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportTenantsBtn">Экспорт</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printTenantsBtn">Печать</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTenantModal">
                                <i class="bi bi-plus-circle"></i> Добавить арендатора
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            Список арендаторов
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Название</th>
                                            <th>Объект</th>
                                            <th>Площадь, м²</th>
                                            <th>Договор</th>
                                            <th>Контакты</th>
                                            <th>Тариф э/э (₽/кВт·ч)</th>
                                            <th>Статус</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tenantsTableBody">
                                        <!-- Данные будут заполнены через JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meter Readings Section -->
                <div id="meter-readings" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Показания счетчиков</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportReadingsBtn">Экспорт</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printReadingsBtn">Печать</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addMeterReadingModal">
                                <i class="bi bi-plus-circle"></i> Ввести показания
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            История показаний счетчиков
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Арендатор</th>
                                            <th>Объект</th>
                                            <th>Период</th>
                                            <th>Электричество, кВт/ч</th>
                                            <th>Газ, м³</th>
                                            <th>Вода, м³</th>
                                            <th>Дата снятия</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="meterReadingsTableBody">
                                        <!-- Данные будут заполнены через JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing Section -->
                <div id="billing" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Расчет платежей</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBillingBtn">Экспорт</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printBillingBtn">Печать</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#calculateBillingModal">
                                <i class="bi bi-plus-circle"></i> Создать расчет
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            Счета за коммунальные услуги
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Период</th>
                                            <th>Арендатор</th>
                                            <th>Объект</th>
                                            <th>Электричество</th>
                                            <th>Газ</th>
                                            <th>Вода</th>
                                            <th>Вывоз мусора</th>
                                            <th>Обслуживание</th>
                                            <th>Итого</th>
                                            <th>Статус</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billingTableBody">
                                        <!-- Данные будут заполнены через JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="payments" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Платежи</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportPaymentsBtn">Экспорт</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printPaymentsBtn">Печать</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                                <i class="bi bi-plus-circle"></i> Добавить платеж
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            История платежей
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Арендатор</th>
                                            <th>Объект</th>
                                            <th>Период</th>
                                            <th>Начислено</th>
                                            <th>Оплачено</th>
                                            <th>Долг</th>
                                            <th>Статус</th>
                                            <th>Дата оплаты</th>
                                            <th>Способ оплаты</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsHistoryTableBody">
                                        <!-- Данные будут заполнены через JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="page-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Отчеты</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportReportsBtn">Экспорт в Excel</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printReportsBtn">Печать</button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Фильтры отчета
                                </div>
                                <div class="card-body">
                                    <form id="reportFilterForm">
                                        <div class="mb-3">
                                            <label for="reportPeriod" class="form-label">Период</label>
                                            <select class="form-select" id="reportPeriod">
                                                <option value="current_month">Текущий месяц</option>
                                                <option value="last_month">Прошлый месяц</option>
                                                <option value="current_quarter">Текущий квартал</option>
                                                <option value="last_quarter">Прошлый квартал</option>
                                                <option value="current_year">Текущий год</option>
                                                <option value="custom">Произвольный период</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="customDateRange" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label for="startDate" class="form-label">Дата начала</label>
                                                    <input type="date" class="form-control" id="startDate">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="endDate" class="form-label">Дата окончания</label>
                                                    <input type="date" class="form-control" id="endDate">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="reportType" class="form-label">Тип отчета</label>
                                            <select class="form-select" id="reportType">
                                                <option value="payments">Платежи</option>
                                                <option value="consumption">Потребление</option>
                                                <option value="debt">Задолженности</option>
                                                <option value="comparison">Сравнительный анализ</option>
                                                <option value="property">По объектам</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="propertyFilterGroup" style="display: none;">
                                            <label for="reportProperty" class="form-label">Объект</label>
                                            <select class="form-select" id="reportProperty">
                                                <option value="all">Все объекты</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="generateReport">Сформировать отчет</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Сводка отчета
                                </div>
                                <div class="card-body">
                                    <div id="reportSummary">
                                        <p>Выберите параметры и сформируйте отчет</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    Детали отчета
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Арендатор</th>
                                                    <th>Объект</th>
                                                    <th>Период</th>
                                                    <th>Начислено</th>
                                                    <th>Оплачено</th>
                                                    <th>Задолженность</th>
                                                    <th>Потребление э/э</th>
                                                    <th>Потребление газа</th>
                                                </tr>
                                            </thead>
                                            <tbody id="reportDetailsTableBody">
                                                <!-- Данные будут заполнены через JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <!-- Модальное окно добавления объекта недвижимости -->
    <div class="modal fade" id="addPropertyModal" tabindex="-1" aria-labelledby="addPropertyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPropertyModalLabel">Добавить объект недвижимости</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPropertyForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="propertyName" class="form-label">Название объекта</label>
                                    <input type="text" class="form-control" id="propertyName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="propertyType" class="form-label">Тип объекта</label>
                                    <select class="form-select" id="propertyType" required>
                                        <option value="residential">Жилой дом</option>
                                        <option value="commercial">Коммерческое здание</option>
                                        <option value="mixed">Смешанного типа</option>
                                        <option value="other">Другое</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="propertyAddress" class="form-label">Адрес</label>
                                    <input type="text" class="form-control" id="propertyAddress" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="propertyTotalArea" class="form-label">Общая площадь (м²)</label>
                                    <input type="number" step="0.01" class="form-control" id="propertyTotalArea" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="propertyRentedArea" class="form-label">Сдаваемая площадь (м²)</label>
                                    <input type="number" step="0.01" class="form-control" id="propertyRentedArea" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="propertyCommonElectricity" class="form-label">Общее потребление э/э (кВт/ч)</label>
                                    <input type="number" step="0.01" class="form-control" id="propertyCommonElectricity" value="0">
                                    <div class="form-text">Общее потребление электроэнергии на объекте</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="propertyCommonGas" class="form-label">Общее потребление газа (м³)</label>
                                    <input type="number" step="0.01" class="form-control" id="propertyCommonGas" value="0">
                                    <div class="form-text">Общее потребление газа на объекте</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="propertyDescription" class="form-label">Описание объекта</label>
                            <textarea class="form-control" id="propertyDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="savePropertyBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления арендатора -->
    <div class="modal fade" id="addTenantModal" tabindex="-1" aria-labelledby="addTenantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTenantModalLabel">Добавить арендатора</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTenantForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantName" class="form-label">ФИО / Название организации</label>
                                    <input type="text" class="form-control" id="tenantName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantBusiness" class="form-label">Вид деятельности</label>
                                    <input type="text" class="form-control" id="tenantBusiness">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantProperty" class="form-label">Объект недвижимости</label>
                                    <select class="form-select" id="tenantProperty" required>
                                        <option value="">Выберите объект</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantArea" class="form-label">Площадь помещения (м²)</label>
                                    <input type="number" step="0.01" class="form-control" id="tenantArea" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantContract" class="form-label">Номер договора</label>
                                    <input type="text" class="form-control" id="tenantContract" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contractDate" class="form-label">Дата договора</label>
                                    <input type="date" class="form-control" id="contractDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantPhone" class="form-label">Телефон</label>
                                    <input type="tel" class="form-control" id="tenantPhone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="tenantEmail">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantStatus" class="form-label">Статус арендатора</label>
                                    <select class="form-select" id="tenantStatus" required>
                                        <option value="active">Активный</option>
                                        <option value="inactive">Неактивный</option>
                                        <option value="suspended">Приостановлен</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tenantElectricityRate" class="form-label">Индивидуальный тариф на электроэнергию (₽/кВт·ч)</label>
                                    <input type="number" step="0.01" class="form-control" id="tenantElectricityRate">
                                    <div class="form-text">Оставьте пустым, чтобы использовать общий тариф</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tenantDescription" class="form-label">Примечания</label>
                            <textarea class="form-control" id="tenantDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveTenantBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления показаний счетчиков -->
    <div class="modal fade" id="addMeterReadingModal" tabindex="-1" aria-labelledby="addMeterReadingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMeterReadingModalLabel">Ввести показания счетчиков</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addMeterReadingForm">
                        <div class="mb-3">
                            <label for="meterReadingTenant" class="form-label">Арендатор</label>
                            <select class="form-select" id="meterReadingTenant" required>
                                <option value="">Выберите арендатора</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="meterReadingPeriod" class="form-label">Период</label>
                            <input type="month" class="form-control" id="meterReadingPeriod" required>
                        </div>
                        <div class="mb-3">
                            <label for="electricityReading" class="form-label">Электричество (кВт/ч)</label>
                            <input type="number" step="0.01" class="form-control" id="electricityReading" required>
                        </div>
                        <div class="mb-3">
                            <label for="gasReading" class="form-label">Газ (м³)</label>
                            <input type="number" step="0.01" class="form-control" id="gasReading">
                        </div>
                        <div class="mb-3">
                            <label for="waterReading" class="form-label">Вода (м³)</label>
                            <input type="number" step="0.01" class="form-control" id="waterReading">
                        </div>
                        <div class="mb-3">
                            <label for="readingDate" class="form-label">Дата снятия показаний</label>
                            <input type="date" class="form-control" id="readingDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveMeterReadingBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно расчета платежей -->
    <div class="modal fade" id="calculateBillingModal" tabindex="-1" aria-labelledby="calculateBillingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calculateBillingModalLabel">Расчет платежей</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="calculateBillingForm">
                        <div class="mb-3">
                            <label for="billingPeriod" class="form-label">Период</label>
                            <input type="month" class="form-control" id="billingPeriod" required>
                        </div>
                        
                        <!-- Поле для общего потребления газа (только при распределении по площади или объекту) -->
                        <div class="mb-3" id="totalGasConsumptionGroup" style="display: none;">
                            <label for="totalGasConsumption" class="form-label">Общее потребление газа за период (м³)</label>
                            <input type="number" step="0.01" class="form-control" id="totalGasConsumption">
                            <div class="form-text">Введите общее потребление газа по общему счетчику</div>
                        </div>

                        <!-- Поле для выбора объекта при распределении по объекту -->
                        <div class="mb-3" id="propertyForDistributionGroup" style="display: none;">
                            <label for="propertyForDistribution" class="form-label">Объект для распределения</label>
                            <select class="form-select" id="propertyForDistribution">
                                <option value="">Выберите объект</option>
                            </select>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeAllTenants" checked>
                            <label class="form-check-label" for="includeAllTenants">
                                Включить всех арендаторов
                            </label>
                        </div>
                        <div class="mb-3" id="specificTenantSelect" style="display: none;">
                            <label for="billingTenant" class="form-label">Арендатор</label>
                            <select class="form-select" id="billingTenant">
                                <option value="">Выберите арендатора</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="billingNotes" class="form-label">Примечания</label>
                            <textarea class="form-control" id="billingNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="calculateBillingBtn">Рассчитать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления платежа -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPaymentModalLabel">Добавить платеж</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPaymentForm">
                        <div class="mb-3">
                            <label for="paymentTenant" class="form-label">Арендатор</label>
                            <select class="form-select" id="paymentTenant" required>
                                <option value="">Выберите арендатора</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentPeriod" class="form-label">Период</label>
                            <input type="month" class="form-control" id="paymentPeriod" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Сумма (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="paymentAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentDate" class="form-label">Дата оплаты</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Способ оплаты</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="cash">Наличные</option>
                                <option value="bank_transfer">Банковский перевод</option>
                                <option value="card">Карта</option>
                                <option value="online">Онлайн</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentNotes" class="form-label">Примечания</label>
                            <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования счета -->
    <div class="modal fade" id="editBillModal" tabindex="-1" aria-labelledby="editBillModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBillModalLabel">Редактировать счет</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBillForm">
                        <div class="mb-3">
                            <label for="editBillPeriod" class="form-label">Период</label>
                            <input type="month" class="form-control" id="editBillPeriod" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editBillTenant" class="form-label">Арендатор</label>
                            <input type="text" class="form-control" id="editBillTenant" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editBillElectricity" class="form-label">Электричество (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="editBillElectricity">
                        </div>
                        <div class="mb-3">
                            <label for="editBillGas" class="form-label">Газ (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="editBillGas">
                        </div>
                        <div class="mb-3">
                            <label for="editBillWater" class="form-label">Вода (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="editBillWater">
                        </div>
                        <div class="mb-3">
                            <label for="editBillGarbage" class="form-label">Вывоз мусора (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="editBillGarbage">
                        </div>
                        <div class="mb-3">
                            <label for="editBillMaintenance" class="form-label">Обслуживание (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="editBillMaintenance">
                        </div>
                        <div class="mb-3">
                            <label for="editBillTotal" class="form-label">Итого (₽)</label>
                            <input type="number" step="0.01" class="form-control" id="editBillTotal" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editBillStatus" class="form-label">Статус</label>
                            <select class="form-select" id="editBillStatus">
                                <option value="unpaid">Не оплачено</option>
                                <option value="partial">Частично оплачено</option>
                                <option value="paid">Оплачено</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveEditBillBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC89JrxravMKbrQxRJaGcEsPCWiUSet-eo",
            authDomain: "communalpayments-a1066.firebaseapp.com",
            projectId: "communalpayments-a1066",
            storageBucket: "communalpayments-a1066.firebasestorage.app",
            messagingSenderId: "338014184655",
            appId: "1:338014184655:web:ee05eeee5a378111db43ba"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Данные приложения
        let appData = {
            properties: [],
            tenants: [],
            meterReadings: [],
            billing: [],
            payments: [],
            tariffs: {
                electricityRate: 5.20,
                electricityNorm: 0.5,
                gasRate: 7.50,
                gasDistribution: 'area',
                waterRate: 45.00,
                garbageRate: 350.00,
                maintenanceRate: 25.00
            },
            reports: []
        };

        // Текущий редактируемый элемент
        let currentEditId = null;
        
        // Статус аутентификации
        let isAuthenticated = false;
        let currentUser = null;
        let isOnline = false;
        let authCheckCompleted = false;

        // Глобальные переменные для графиков
        let yearlyChart = null;
        let paymentStatusChart = null;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            // Загрузка данных из localStorage
            loadData();
            
            // Инициализация Firebase
            initFirebase();
            
            // Инициализация навигации
            initNavigation();
            
            // Инициализация графиков
            initCharts();
            
            // Инициализация обработчиков событий
            initEventHandlers();
            
            // Заполнение таблиц данными
            populateTables();
            
            // Заполнение выпадающих списков
            populateSelects();
            
            // Обновление статистики
            updateDashboardStats();
            
            // Инициализация формы тарифов
            initTariffsForm();
        });

        // Инициализация Firebase
        function initFirebase() {
            if (!window.firebaseAuth) {
                console.log('Firebase не загружен, работа в оффлайн режиме');
                authCheckCompleted = true;
                // Показываем экран аутентификации сразу
                showAuth();
                return;
            }
            
            const auth = window.firebaseAuth;
            
            // Показать индикатор загрузки аутентификации
            document.getElementById('auth-loading').style.display = 'block';
            document.getElementById('auth-form').style.display = 'none';
            
            // Слушатель изменения состояния аутентификации
            auth.onAuthStateChanged((user) => {
                console.log('Auth state changed:', user);
                authCheckCompleted = true;
                document.getElementById('auth-loading').style.display = 'none';
                document.getElementById('auth-form').style.display = 'block';
                
                if (user) {
                    // Пользователь вошел в систему
                    currentUser = user;
                    isAuthenticated = true;
                    updateUserInterface();
                    loadDataFromFirestore();
                    showApp();
                } else {
                    // Пользователь вышел из системы
                    currentUser = null;
                    isAuthenticated = false;
                    showAuth();
                }
            });
        }

        // Инициализация формы тарифов
        function initTariffsForm() {
            document.getElementById('electricityRate').value = appData.tariffs.electricityRate;
            document.getElementById('electricityNorm').value = appData.tariffs.electricityNorm;
            document.getElementById('gasRate').value = appData.tariffs.gasRate;
            document.getElementById('gasDistribution').value = appData.tariffs.gasDistribution;
            document.getElementById('waterRate').value = appData.tariffs.waterRate;
            document.getElementById('garbageRate').value = appData.tariffs.garbageRate;
            document.getElementById('maintenanceRate').value = appData.tariffs.maintenanceRate;
        }

        // Показать экран аутентификации
        function showAuth() {
            console.log('Showing auth screen');
            document.getElementById('auth-screen').style.display = 'block';
            document.getElementById('app-screen').style.display = 'none';
        }

        // Показать основное приложение
        function showApp() {
            console.log('Showing app screen');
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
        }

        // Обновление интерфейса пользователя
        function updateUserInterface() {
            if (currentUser) {
                const email = currentUser.email;
                document.getElementById('user-email').textContent = email;
                document.getElementById('user-avatar').textContent = email.charAt(0).toUpperCase();
            } else {
                document.getElementById('user-email').textContent = 'Оффлайн режим';
                document.getElementById('user-avatar').textContent = 'O';
            }
        }

        // Загрузка данных из Firebase
        async function loadDataFromFirestore() {
            if (!isAuthenticated || !currentUser) return;
            
            try {
                showSyncStatus('Синхронизация...', true);
                
                const userId = currentUser.uid;
                const docRef = db.collection("users").doc(userId);
                const docSnap = await docRef.get();
                
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    appData = userData.appData || appData;
                    saveDataToLocalStorage();
                    populateTables();
                    updateDashboardStats();
                    initTariffsForm();
                    showSyncStatus('Синхронизировано', false);
                    isOnline = true;
                } else {
                    // Если документ не существует, создаем его
                    await docRef.set({
                        appData: appData,
                        email: currentUser.email,
                        lastSync: new Date().toISOString()
                    });
                    showSyncStatus('Данные созданы в облаке', false);
                    isOnline = true;
                }
            } catch (error) {
                console.error('Ошибка загрузки из Firebase:', error);
                showSyncStatus('Ошибка синхронизации', false);
                // Загружаем данные из localStorage как запасной вариант
                loadDataFromLocalStorage();
            }
        }

        // Сохранение данных в Firebase
        async function saveDataToFirestore() {
            if (!isAuthenticated || !currentUser) return;
            
            try {
                showSyncStatus('Сохранение...', true);
                
                const userId = currentUser.uid;
                const docRef = db.collection("users").doc(userId);
                
                await docRef.set({
                    appData: appData,
                    email: currentUser.email,
                    lastSync: new Date().toISOString()
                }, { merge: true });
                
                showSyncStatus('Синхронизировано', false);
                isOnline = true;
            } catch (error) {
                console.error('Ошибка сохранения в Firebase:', error);
                showSyncStatus('Ошибка сохранения', false);
            }
        }

        // Показать статус синхронизации
        function showSyncStatus(message, loading) {
            const statusElement = document.getElementById('sync-status-text');
            const spinnerElement = document.getElementById('sync-spinner');
            
            if (statusElement) {
                statusElement.textContent = message;
            }
            if (spinnerElement) {
                spinnerElement.style.display = loading ? 'inline-block' : 'none';
            }
        }

        // Загрузка данных из localStorage
        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('utilityBillingData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    // Проверяем структуру данных и объединяем с defaults
                    appData = {
                        properties: parsedData.properties || [],
                        tenants: parsedData.tenants || [],
                        meterReadings: parsedData.meterReadings || [],
                        billing: parsedData.billing || [],
                        payments: parsedData.payments || [],
                        tariffs: {
                            electricityRate: parsedData.tariffs?.electricityRate || 5.20,
                            electricityNorm: parsedData.tariffs?.electricityNorm || 0.5,
                            gasRate: parsedData.tariffs?.gasRate || 7.50,
                            gasDistribution: parsedData.tariffs?.gasDistribution || 'area',
                            waterRate: parsedData.tariffs?.waterRate || 45.00,
                            garbageRate: parsedData.tariffs?.garbageRate || 350.00,
                            maintenanceRate: parsedData.tariffs?.maintenanceRate || 25.00
                        },
                        reports: parsedData.reports || []
                    };
                } catch (e) {
                    console.error('Ошибка загрузки данных из localStorage:', e);
                }
            }
            
            populateTables();
            updateDashboardStats();
            initTariffsForm();
            isOnline = false;
            showSyncStatus('Локальные данные', false);
        }

        // Сохранение данных в localStorage
        function saveDataToLocalStorage() {
            localStorage.setItem('utilityBillingData', JSON.stringify(appData));
        }

        // Универсальная функция сохранения данных
        function saveData() {
            saveDataToLocalStorage();
            if (isAuthenticated && currentUser) {
                saveDataToFirestore();
            }
        }

        // Загрузка данных (совместимость со старым кодом)
        function loadData() {
            loadDataFromLocalStorage();
        }

        // Инициализация тестовых данных
        function initializeSampleData() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            const currentPeriod = `${currentYear}-${currentMonth.toString().padStart(2, '0')}`;
            
            appData.properties = [
                {
                    id: 1,
                    name: 'Торговый центр "Центральный"',
                    type: 'commercial',
                    address: 'ул. Ленина, 1',
                    totalArea: 2000,
                    rentedArea: 1500,
                    commonElectricity: 500,
                    commonGas: 200,
                    description: 'Торговый центр в центре города'
                },
                {
                    id: 2,
                    name: 'Офисное здание "Бизнес-парк"',
                    type: 'commercial',
                    address: 'пр. Мира, 25',
                    totalArea: 1500,
                    rentedArea: 1200,
                    commonElectricity: 300,
                    commonGas: 150,
                    description: 'Офисное здание класса А'
                }
            ];

            appData.tenants = [
                {
                    id: 1,
                    name: 'Иван Петров',
                    business: 'Магазин "Электроника"',
                    propertyId: 1,
                    area: 85.5,
                    contract: '№123 от 15.03.2022',
                    contractDate: '2022-03-15',
                    phone: '+7 (912) 345-67-89',
                    email: 'ivan@example.com',
                    description: '',
                    status: 'active',
                    electricityRate: null // Использовать общий тариф
                },
                {
                    id: 2,
                    name: 'ООО "Ромашка"',
                    business: 'Цветочный магазин',
                    propertyId: 1,
                    area: 120.0,
                    contract: '№124 от 20.04.2022',
                    contractDate: '2022-04-20',
                    phone: '+7 (912) 987-65-43',
                    email: 'info@romashka.ru',
                    description: '',
                    status: 'active',
                    electricityRate: 5.50 // Индивидуальный тариф
                },
                {
                    id: 3,
                    name: 'Анна Сидорова',
                    business: 'Салон красоты',
                    propertyId: 2,
                    area: 65.3,
                    contract: '№125 от 05.05.2022',
                    contractDate: '2022-05-05',
                    phone: '+7 (912) 555-44-33',
                    email: 'anna@example.com',
                    description: '',
                    status: 'active',
                    electricityRate: null // Использовать общий тариф
                }
            ];

            appData.meterReadings = [
                {
                    id: 1,
                    tenantId: 1,
                    period: currentPeriod,
                    electricity: 1250,
                    gas: 45,
                    water: 12,
                    date: new Date().toISOString().split('T')[0]
                },
                {
                    id: 2,
                    tenantId: 2,
                    period: currentPeriod,
                    electricity: 1850,
                    gas: 65,
                    water: 18,
                    date: new Date().toISOString().split('T')[0]
                },
                {
                    id: 3,
                    tenantId: 3,
                    period: currentPeriod,
                    electricity: 950,
                    gas: 30,
                    water: 8,
                    date: new Date().toISOString().split('T')[0]
                }
            ];

            appData.billing = [
                {
                    id: 1,
                    period: currentPeriod,
                    tenantId: 1,
                    electricity: 6500,
                    gas: 337.5,
                    water: 540,
                    garbage: 350,
                    maintenance: 2137.5,
                    total: 9865,
                    status: 'paid'
                },
                {
                    id: 2,
                    period: currentPeriod,
                    tenantId: 2,
                    electricity: 9620,
                    gas: 487.5,
                    water: 810,
                    garbage: 350,
                    maintenance: 3000,
                    total: 14267.5,
                    status: 'partial'
                },
                {
                    id: 3,
                    period: currentPeriod,
                    tenantId: 3,
                    electricity: 4940,
                    gas: 225,
                    water: 360,
                    garbage: 350,
                    maintenance: 1632.5,
                    total: 7507.5,
                    status: 'unpaid'
                }
            ];

            appData.payments = [
                {
                    id: 1,
                    tenantId: 1,
                    period: currentPeriod,
                    amount: 9865,
                    date: new Date().toISOString().split('T')[0],
                    method: 'bank_transfer',
                    notes: '',
                    status: 'paid'
                },
                {
                    id: 2,
                    tenantId: 2,
                    period: currentPeriod,
                    amount: 8000,
                    date: new Date().toISOString().split('T')[0],
                    method: 'cash',
                    notes: 'Частичная оплата',
                    status: 'partial'
                },
                {
                    id: 3,
                    tenantId: 3,
                    period: currentPeriod,
                    amount: 0,
                    date: '',
                    method: '',
                    notes: '',
                    status: 'unpaid'
                }
            ];

            saveData();
        }

        // Инициализация навигации
        function initNavigation() {
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    document.querySelectorAll('.sidebar .nav-link').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.page-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Show selected section
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                });
            });
        }

        // Инициализация графиков
        function initCharts() {
            // Yearly payments chart
            const yearlyCtx = document.getElementById('yearlyChart');
            if (yearlyCtx) {
                if (yearlyChart) {
                    yearlyChart.destroy();
                }
                yearlyChart = new Chart(yearlyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
                        datasets: [{
                            label: 'Платежи, тыс. руб.',
                            data: getYearlyPaymentData(),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' тыс.';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Payment status chart
            const statusCtx = document.getElementById('paymentStatusChart');
            if (statusCtx) {
                if (paymentStatusChart) {
                    paymentStatusChart.destroy();
                }
                paymentStatusChart = new Chart(statusCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Оплачено', 'Частично', 'Не оплачено'],
                        datasets: [{
                            data: getPaymentStatusData(),
                            backgroundColor: [
                                '#2ecc71',
                                '#f39c12',
                                '#e74c3c'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // Получение данных для годового графика
        function getYearlyPaymentData() {
            const currentYear = new Date().getFullYear();
            const monthlyTotals = new Array(12).fill(0);
            
            appData.payments.forEach(payment => {
                const [year, month] = payment.period.split('-');
                if (parseInt(year) === currentYear) {
                    const monthIndex = parseInt(month) - 1;
                    monthlyTotals[monthIndex] += payment.amount;
                }
            });
            
            // Переводим в тысячи рублей
            return monthlyTotals.map(amount => Math.round(amount / 1000));
        }

        // Получение данных для графика статуса оплаты
        function getPaymentStatusData() {
            const paid = appData.billing.filter(bill => bill.status === 'paid').length;
            const partial = appData.billing.filter(bill => bill.status === 'partial').length;
            const unpaid = appData.billing.filter(bill => bill.status === 'unpaid').length;
            
            return [paid, partial, unpaid];
        }

        // Инициализация обработчиков событий
        function initEventHandlers() {
            console.log('Initializing event handlers...');
            
            // Обработчики аутентификации
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Auth form submitted');
                    handleAuth();
                });
            } else {
                console.error('Auth form not found');
            }
            
            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) {
                registerBtn.addEventListener('click', function() {
                    console.log('Register button clicked');
                    handleAuth(true);
                });
            } else {
                console.error('Register button not found');
            }
            
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            } else {
                console.error('Logout button not found');
            }
            
            const offlineModeBtn = document.getElementById('offline-mode-btn');
            if (offlineModeBtn) {
                offlineModeBtn.addEventListener('click', function() {
                    console.log('Offline mode button clicked');
                    // Ждем завершения проверки аутентификации перед переходом в оффлайн режим
                    if (!authCheckCompleted) {
                        const checkAuthInterval = setInterval(() => {
                            if (authCheckCompleted) {
                                clearInterval(checkAuthInterval);
                                loadDataFromLocalStorage();
                                showApp();
                                updateUserInterface();
                                document.getElementById('sync-status-text').textContent = 'Работа в оффлайн режиме';
                            }
                        }, 100);
                    } else {
                        loadDataFromLocalStorage();
                        showApp();
                        updateUserInterface();
                        document.getElementById('sync-status-text').textContent = 'Работа в оффлайн режиме';
                    }
                });
            } else {
                console.error('Offline mode button not found');
            }
            
            // Обработчики для управления данными
            document.getElementById('createBackupBtn').addEventListener('click', createBackup);
            document.getElementById('restoreBackupBtn').addEventListener('click', function() {
                document.getElementById('backupFileInput').click();
            });
            document.getElementById('backupFileInput').addEventListener('change', restoreBackup);
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
            document.getElementById('sync-now-btn').addEventListener('click', syncData);
            
            // Обработчики для модальных окон
            document.getElementById('savePropertyBtn').addEventListener('click', saveProperty);
            document.getElementById('saveTenantBtn').addEventListener('click', saveTenant);
            document.getElementById('saveMeterReadingBtn').addEventListener('click', saveMeterReading);
            document.getElementById('calculateBillingBtn').addEventListener('click', calculateBilling);
            document.getElementById('savePaymentBtn').addEventListener('click', savePayment);
            document.getElementById('saveTariffs').addEventListener('click', saveTariffs);
            document.getElementById('saveEditBillBtn').addEventListener('click', saveEditBill);
            
            // Обработчики для форм
            document.getElementById('includeAllTenants').addEventListener('change', function() {
                document.getElementById('specificTenantSelect').style.display = 
                    this.checked ? 'none' : 'block';
            });
            
            document.getElementById('reportPeriod').addEventListener('change', function() {
                document.getElementById('customDateRange').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('reportType').addEventListener('change', function() {
                document.getElementById('propertyFilterGroup').style.display = 
                    this.value === 'property' ? 'block' : 'none';
            });
            
            document.getElementById('generateReport').addEventListener('click', generateReport);
            
            // Обработчики для кнопок экспорта и печати
            document.getElementById('exportDashboardBtn').addEventListener('click', () => exportSection('dashboard'));
            document.getElementById('printDashboardBtn').addEventListener('click', () => printSection('dashboard'));
            document.getElementById('exportPropertiesBtn').addEventListener('click', () => exportSection('properties'));
            document.getElementById('printPropertiesBtn').addEventListener('click', () => printSection('properties'));
            document.getElementById('exportTenantsBtn').addEventListener('click', () => exportSection('tenants'));
            document.getElementById('printTenantsBtn').addEventListener('click', () => printSection('tenants'));
            document.getElementById('exportReadingsBtn').addEventListener('click', () => exportSection('meter-readings'));
            document.getElementById('printReadingsBtn').addEventListener('click', () => printSection('meter-readings'));
            document.getElementById('exportBillingBtn').addEventListener('click', () => exportSection('billing'));
            document.getElementById('printBillingBtn').addEventListener('click', () => printSection('billing'));
            document.getElementById('exportPaymentsBtn').addEventListener('click', () => exportSection('payments'));
            document.getElementById('printPaymentsBtn').addEventListener('click', () => printSection('payments'));
            document.getElementById('exportReportsBtn').addEventListener('click', () => exportSection('reports'));
            document.getElementById('printReportsBtn').addEventListener('click', () => printSection('reports'));
            
            // Обработчик для кнопки "Показать все" на дашборде
            document.getElementById('showAllPayments').addEventListener('click', function(e) {
                e.preventDefault();
                // Переключение на секцию платежей
                document.querySelectorAll('.sidebar .nav-link').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector('.sidebar .nav-link[data-section="payments"]').classList.add('active');
                
                document.querySelectorAll('.page-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('payments').classList.add('active');
            });
            
            // Обработчик для закрытия модальных окон
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function() {
                    // Сброс формы и состояния редактирования
                    const form = this.querySelector('form');
                    if (form) {
                        form.reset();
                    }
                    currentEditId = null;
                    if (this.id === 'addPropertyModal') {
                        document.getElementById('addPropertyModalLabel').textContent = 'Добавить объект';
                        document.getElementById('savePropertyBtn').onclick = saveProperty;
                    }
                    if (this.id === 'addTenantModal') {
                        document.getElementById('addTenantModalLabel').textContent = 'Добавить арендатора';
                        document.getElementById('saveTenantBtn').onclick = saveTenant;
                    }
                    if (this.id === 'addMeterReadingModal') {
                        document.getElementById('addMeterReadingModalLabel').textContent = 'Ввести показания';
                        document.getElementById('saveMeterReadingBtn').onclick = saveMeterReading;
                    }
                    if (this.id === 'addPaymentModal') {
                        document.getElementById('addPaymentModalLabel').textContent = 'Добавить платеж';
                        document.getElementById('savePaymentBtn').onclick = savePayment;
                    }
                });
            });

            // Обработчики для обновления итоговой суммы при редактировании счета
            document.getElementById('editBillElectricity').addEventListener('input', updateEditBillTotal);
            document.getElementById('editBillGas').addEventListener('input', updateEditBillTotal);
            document.getElementById('editBillWater').addEventListener('input', updateEditBillTotal);
            document.getElementById('editBillGarbage').addEventListener('input', updateEditBillTotal);
            document.getElementById('editBillMaintenance').addEventListener('input', updateEditBillTotal);

            // Обработчик для показа/скрытия поля общего потребления газа
            document.getElementById('calculateBillingModal').addEventListener('show.bs.modal', function() {
                const gasDistribution = appData.tariffs.gasDistribution;
                if (gasDistribution === 'area' || gasDistribution === 'property') {
                    document.getElementById('totalGasConsumptionGroup').style.display = 'block';
                    if (gasDistribution === 'property') {
                        document.getElementById('propertyForDistributionGroup').style.display = 'block';
                        populatePropertySelect('propertyForDistribution');
                    } else {
                        document.getElementById('propertyForDistributionGroup').style.display = 'none';
                    }
                } else {
                    document.getElementById('totalGasConsumptionGroup').style.display = 'none';
                    document.getElementById('propertyForDistributionGroup').style.display = 'none';
                }
            });

            // Обработчик изменения метода распределения газа в настройках
            document.getElementById('gasDistribution').addEventListener('change', function() {
                const gasDistribution = this.value;
                if (gasDistribution === 'property') {
                    // При выборе распределения по объекту, показываем дополнительные поля
                    alert('При распределении по объекту необходимо указать общее потребление газа для каждого объекта и выбрать объект при расчете платежей.');
                }
            });
        }

        // Обновление итоговой суммы при редактировании счета
        function updateEditBillTotal() {
            const electricity = parseFloat(document.getElementById('editBillElectricity').value) || 0;
            const gas = parseFloat(document.getElementById('editBillGas').value) || 0;
            const water = parseFloat(document.getElementById('editBillWater').value) || 0;
            const garbage = parseFloat(document.getElementById('editBillGarbage').value) || 0;
            const maintenance = parseFloat(document.getElementById('editBillMaintenance').value) || 0;
            
            const total = electricity + gas + water + garbage + maintenance;
            document.getElementById('editBillTotal').value = total.toFixed(2);
        }

        // Обработка аутентификации
        async function handleAuth(isRegister = false) {
            console.log('handleAuth called, isRegister:', isRegister);
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorElement = document.getElementById('auth-error');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            
            if (!window.firebaseAuth) {
                errorElement.textContent = 'Firebase не загружен. Используйте оффлайн режим.';
                errorElement.classList.remove('d-none');
                return;
            }
            
            // Блокируем кнопки во время аутентификации
            loginBtn.disabled = true;
            registerBtn.disabled = true;
            loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Вход...';
            registerBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Регистрация...';
            
            try {
                if (isRegister) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                errorElement.classList.add('d-none');
            } catch (error) {
                console.error('Auth error:', error);
                errorElement.textContent = `Ошибка ${isRegister ? 'регистрации' : 'входа'}: ${error.message}`;
                errorElement.classList.remove('d-none');
                
                // Восстанавливаем кнопки после ошибки
                loginBtn.disabled = false;
                registerBtn.disabled = false;
                loginBtn.textContent = 'Войти';
                registerBtn.textContent = 'Зарегистрироваться';
            }
        }

        // Выход из системы
        async function handleLogout() {
            console.log('handleLogout called');
            
            if (!window.firebaseAuth) {
                // Если Firebase не загружен, просто показываем экран аутентификации
                showAuth();
                return;
            }
            
            const logoutBtn = document.getElementById('logout-btn');
            const originalText = logoutBtn.innerHTML;
            
            try {
                logoutBtn.disabled = true;
                logoutBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Выход...';
                
                await auth.signOut();
                
                // Восстанавливаем кнопку после успешного выхода
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = originalText;
            } catch (error) {
                console.error('Logout error:', error);
                alert('Ошибка при выходе из системы: ' + error.message);
                
                // Восстанавливаем кнопку после ошибки
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = originalText;
            }
        }

        // Синхронизация данных
        async function syncData() {
            if (isAuthenticated && currentUser) {
                await saveDataToFirestore();
            } else {
                alert('Для синхронизации необходимо войти в систему');
            }
        }

        // Создание резервной копии
        function createBackup() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `utility_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Резервная копия создана и скачана');
        }

        // Восстановление из резервной копии
        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Проверка структуры данных
                    if (backupData.tenants !== undefined && backupData.tariffs !== undefined) {
                        if (confirm('Вы уверены, что хотите восстановить данные из резервной копии? Текущие данные будут заменены.')) {
                            appData = backupData;
                            saveData();
                            populateTables();
                            updateDashboardStats();
                            initTariffsForm();
                            alert('Данные успешно восстановлены из резервной копии');
                        }
                    } else {
                        alert('Ошибка: файл не содержит корректных данных для восстановления');
                    }
                } catch (error) {
                    alert('Ошибка при чтении файла: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Сброс значения input
            event.target.value = '';
        }

        // Очистка всех данных
        function clearAllData() {
            if (confirm('ВНИМАНИЕ: Вы уверены, что хотите удалить ВСЕ данные? Это действие невозможно отменить. Все данные будут удалены безвозвратно.')) {
                if (confirm('Это последнее предупреждение. Все данные будут удалены. Продолжить?')) {
                    // Очистка appData
                    appData = {
                        properties: [],
                        tenants: [],
                        meterReadings: [],
                        billing: [],
                        payments: [],
                        tariffs: {
                            electricityRate: 5.20,
                            electricityNorm: 0.5,
                            gasRate: 7.50,
                            gasDistribution: 'area',
                            waterRate: 45.00,
                            garbageRate: 350.00,
                            maintenanceRate: 25.00
                        },
                        reports: []
                    };
                    
                    // Очистка localStorage
                    localStorage.removeItem('utilityBillingData');
                    
                    // Очистка Firebase (если пользователь аутентифицирован)
                    if (isAuthenticated && currentUser) {
                        saveDataToFirestore();
                    }
                    
                    // Обновление интерфейса
                    populateTables();
                    updateDashboardStats();
                    initTariffsForm();
                    
                    alert('Все данные были успешно удалены');
                }
            }
        }

        // Заполнение таблиц данными
        function populateTables() {
            populatePropertiesTable();
            populateTenantsTable();
            populateMeterReadingsTable();
            populateBillingTable();
            populatePaymentsTable();
            populatePaymentsHistoryTable();
        }

        // Заполнение выпадающих списков
        function populateSelects() {
            populatePropertySelect('tenantProperty');
            populatePropertySelect('reportProperty');
            
            const tenantSelects = [
                'meterReadingTenant',
                'billingTenant',
                'paymentTenant'
            ];
            
            tenantSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Выберите арендатора</option>';
                    
                    appData.tenants.forEach(tenant => {
                        const option = document.createElement('option');
                        option.value = tenant.id;
                        option.textContent = tenant.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Заполнение выпадающего списка объектов
        function populatePropertySelect(selectId) {
            const select = document.getElementById(selectId);
            if (select) {
                // Сохраняем текущее значение
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">Выберите объект</option>';
                
                appData.properties.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property.id;
                    option.textContent = property.name;
                    select.appendChild(option);
                });
                
                // Восстанавливаем предыдущее значение, если оно есть
                if (currentValue) {
                    select.value = currentValue;
                }
            }
        }

        // Заполнение таблицы объектов недвижимости
        function populatePropertiesTable() {
            const tbody = document.getElementById('propertiesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.properties.forEach(property => {
                const tenantsInProperty = appData.tenants.filter(tenant => tenant.propertyId === property.id);
                const totalElectricity = tenantsInProperty.reduce((sum, tenant) => {
                    const readings = appData.meterReadings.filter(r => r.tenantId === tenant.id);
                    return sum + readings.reduce((s, r) => s + (r.electricity || 0), 0);
                }, 0);
                
                const totalGas = tenantsInProperty.reduce((sum, tenant) => {
                    const readings = appData.meterReadings.filter(r => r.tenantId === tenant.id);
                    return sum + readings.reduce((s, r) => s + (r.gas || 0), 0);
                }, 0);
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${property.name}</td>
                    <td>${property.address}</td>
                    <td>${property.totalArea}</td>
                    <td>${tenantsInProperty.length}</td>
                    <td>${totalElectricity.toLocaleString()} кВт/ч</td>
                    <td>${totalGas.toLocaleString()} м³</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewProperty(${property.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editProperty(${property.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty(${property.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Заполнение таблицы арендаторов
        function populateTenantsTable() {
            const tbody = document.getElementById('tenantsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.tenants.forEach(tenant => {
                const property = appData.properties.find(p => p.id === tenant.propertyId);
                const propertyName = property ? property.name : 'Не указан';
                
                // Создание аватара из инициалов
                const initials = tenant.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Определение тарифа на электроэнергию
                const electricityRate = tenant.electricityRate !== null ? 
                    tenant.electricityRate : appData.tariffs.electricityRate;
                
                // Определение статуса
                let statusBadge = '';
                switch(tenant.status) {
                    case 'active':
                        statusBadge = '<span class="badge bg-success">Активен</span>';
                        break;
                    case 'inactive':
                        statusBadge = '<span class="badge bg-secondary">Неактивен</span>';
                        break;
                    case 'suspended':
                        statusBadge = '<span class="badge bg-warning">Приостановлен</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge bg-secondary">Неизвестен</span>';
                }
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="tenant-avatar">${initials}</div>
                            <div>
                                <div>${tenant.name}</div>
                                <small class="text-muted">${tenant.business}</small>
                            </div>
                        </div>
                    </td>
                    <td>${propertyName}</td>
                    <td>${tenant.area}</td>
                    <td>${tenant.contract}</td>
                    <td>${tenant.phone}<br>${tenant.email}</td>
                    <td>${electricityRate} ${tenant.electricityRate !== null ? '<span class="badge bg-info">инд.</span>' : ''}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTenant(${tenant.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editTenant(${tenant.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTenant(${tenant.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Заполнение таблицы показаний счетчиков
        function populateMeterReadingsTable() {
            const tbody = document.getElementById('meterReadingsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.meterReadings.forEach(reading => {
                const tenant = appData.tenants.find(t => t.id === reading.tenantId);
                if (!tenant) return;
                
                const property = appData.properties.find(p => p.id === tenant.propertyId);
                const propertyName = property ? property.name : 'Не указан';
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${tenant.name}</td>
                    <td>${propertyName}</td>
                    <td>${formatPeriod(reading.period)}</td>
                    <td>${reading.electricity || '-'}</td>
                    <td>${reading.gas || '-'}</td>
                    <td>${reading.water || '-'}</td>
                    <td>${formatDate(reading.date)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewMeterReading(${reading.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editMeterReading(${reading.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMeterReading(${reading.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Заполнение таблицы расчетов
        function populateBillingTable() {
            const tbody = document.getElementById('billingTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.billing.forEach(bill => {
                const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                if (!tenant) return;
                
                const property = appData.properties.find(p => p.id === tenant.propertyId);
                const propertyName = property ? property.name : 'Не указан';
                
                const statusBadge = bill.status === 'paid' ? 
                    '<span class="badge bg-success">Оплачено</span>' : 
                    bill.status === 'partial' ? 
                    '<span class="badge bg-warning">Частично</span>' : 
                    '<span class="badge bg-danger">Не оплачено</span>';
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${formatPeriod(bill.period)}</td>
                    <td>${tenant.name}</td>
                    <td>${propertyName}</td>
                    <td>${formatCurrency(bill.electricity)}</td>
                    <td>${formatCurrency(bill.gas)}</td>
                    <td>${formatCurrency(bill.water)}</td>
                    <td>${formatCurrency(bill.garbage)}</td>
                    <td>${formatCurrency(bill.maintenance)}</td>
                    <td>${formatCurrency(bill.total)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBill(${bill.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editBill(${bill.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBill(${bill.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Заполнение таблицы платежей на дашборде
        function populatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Показать только последние платежи
            const recentPayments = appData.payments.slice(0, 5);
            
            recentPayments.forEach(payment => {
                const tenant = appData.tenants.find(t => t.id === payment.tenantId);
                if (!tenant) return;
                
                const bill = appData.billing.find(b => b.tenantId === payment.tenantId && b.period === payment.period);
                const charged = bill ? bill.total : 0;
                const debt = charged - payment.amount;
                
                const statusBadge = payment.status === 'paid' ? 
                    '<span class="badge bg-success">Оплачено</span>' : 
                    payment.status === 'partial' ? 
                    '<span class="badge bg-warning">Частично</span>' : 
                    '<span class="badge bg-danger">Не оплачено</span>';
                
                const paymentDate = payment.date ? formatDate(payment.date) : '-';
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="tenant-avatar">${tenant.name.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                            <div>${tenant.name}</div>
                        </div>
                    </td>
                    <td>${formatPeriod(payment.period)}</td>
                    <td>${formatCurrency(charged)}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${formatCurrency(debt)}</td>
                    <td>${statusBadge}</td>
                    <td>${paymentDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editPayment(${payment.id})"><i class="bi bi-pencil"></i></button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Заполнение таблицы истории платежей
        function populatePaymentsHistoryTable() {
            const tbody = document.getElementById('paymentsHistoryTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.payments.forEach(payment => {
                const tenant = appData.tenants.find(t => t.id === payment.tenantId);
                if (!tenant) return;
                
                const property = appData.properties.find(p => p.id === tenant.propertyId);
                const propertyName = property ? property.name : 'Не указан';
                
                const bill = appData.billing.find(b => b.tenantId === payment.tenantId && b.period === payment.period);
                const charged = bill ? bill.total : 0;
                const debt = charged - payment.amount;
                
                const statusBadge = payment.status === 'paid' ? 
                    '<span class="badge bg-success">Оплачено</span>' : 
                    payment.status === 'partial' ? 
                    '<span class="badge bg-warning">Частично</span>' : 
                    '<span class="badge bg-danger">Не оплачено</span>';
                
                const paymentDate = payment.date ? formatDate(payment.date) : '-';
                const paymentMethod = getPaymentMethodText(payment.method);
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${tenant.name}</td>
                    <td>${propertyName}</td>
                    <td>${formatPeriod(payment.period)}</td>
                    <td>${formatCurrency(charged)}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${formatCurrency(debt)}</td>
                    <td>${statusBadge}</td>
                    <td>${paymentDate}</td>
                    <td>${paymentMethod}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPayment(${payment.id})"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editPayment(${payment.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePayment(${payment.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Функции для работы с объектами недвижимости
        function saveProperty() {
            const form = document.getElementById('addPropertyForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            if (currentEditId) {
                // Редактирование существующего объекта
                updateProperty(currentEditId);
            } else {
                // Добавление нового объекта
                const newProperty = {
                    id: appData.properties.length > 0 ? Math.max(...appData.properties.map(p => p.id)) + 1 : 1,
                    name: document.getElementById('propertyName').value,
                    type: document.getElementById('propertyType').value,
                    address: document.getElementById('propertyAddress').value,
                    totalArea: parseFloat(document.getElementById('propertyTotalArea').value),
                    rentedArea: parseFloat(document.getElementById('propertyRentedArea').value),
                    commonElectricity: parseFloat(document.getElementById('propertyCommonElectricity').value) || 0,
                    commonGas: parseFloat(document.getElementById('propertyCommonGas').value) || 0,
                    description: document.getElementById('propertyDescription').value
                };
                
                // Проверка на дубликаты
                const existingProperty = appData.properties.find(p => 
                    p.name === newProperty.name && p.address === newProperty.address);
                
                if (existingProperty) {
                    alert('Объект с таким названием и адресом уже существует');
                    return;
                }
                
                appData.properties.push(newProperty);
                saveData();
                populatePropertiesTable();
                populateSelects();
                
                // Сбросить ID редактирования
                currentEditId = null;
                
                // Закрыть модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('addPropertyModal'));
                modal.hide();
            }
        }

        function editProperty(id) {
            const property = appData.properties.find(p => p.id === id);
            if (!property) return;
            
            currentEditId = id;
            
            // Заполнить форму данными объекта
            document.getElementById('propertyName').value = property.name;
            document.getElementById('propertyType').value = property.type;
            document.getElementById('propertyAddress').value = property.address;
            document.getElementById('propertyTotalArea').value = property.totalArea;
            document.getElementById('propertyRentedArea').value = property.rentedArea;
            document.getElementById('propertyCommonElectricity').value = property.commonElectricity || 0;
            document.getElementById('propertyCommonGas').value = property.commonGas || 0;
            document.getElementById('propertyDescription').value = property.description || '';
            
            // Показать модальное окно
            const modal = new bootstrap.Modal(document.getElementById('addPropertyModal'));
            modal.show();
            
            // Изменить заголовок
            document.getElementById('addPropertyModalLabel').textContent = 'Редактировать объект';
        }

        function updateProperty(id) {
            const form = document.getElementById('addPropertyForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const propertyIndex = appData.properties.findIndex(p => p.id === id);
            if (propertyIndex === -1) return;
            
            appData.properties[propertyIndex] = {
                ...appData.properties[propertyIndex],
                name: document.getElementById('propertyName').value,
                type: document.getElementById('propertyType').value,
                address: document.getElementById('propertyAddress').value,
                totalArea: parseFloat(document.getElementById('propertyTotalArea').value),
                rentedArea: parseFloat(document.getElementById('propertyRentedArea').value),
                commonElectricity: parseFloat(document.getElementById('propertyCommonElectricity').value) || 0,
                commonGas: parseFloat(document.getElementById('propertyCommonGas').value) || 0,
                description: document.getElementById('propertyDescription').value
            };
            
            saveData();
            populatePropertiesTable();
            populateSelects();
            
            // Закрыть модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPropertyModal'));
            modal.hide();
            
            // Сбросить ID редактирования
            currentEditId = null;
        }

        function deleteProperty(id) {
            // Проверить, есть ли арендаторы, связанные с этим объектом
            const tenantsWithProperty = appData.tenants.filter(t => t.propertyId === id);
            if (tenantsWithProperty.length > 0) {
                alert('Нельзя удалить объект, с которым связаны арендаторы. Сначала удалите или переместите арендаторов.');
                return;
            }
            
            if (confirm('Вы уверены, что хотите удалить этот объект?')) {
                appData.properties = appData.properties.filter(p => p.id !== id);
                saveData();
                populatePropertiesTable();
                populateSelects();
            }
        }

        function viewProperty(id) {
            const property = appData.properties.find(p => p.id === id);
            if (!property) return;
            
            const tenantsInProperty = appData.tenants.filter(tenant => tenant.propertyId === id);
            const activeTenants = tenantsInProperty.filter(t => t.status === 'active');
            
            const modalContent = `
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр объекта недвижимости</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Название:</strong> ${property.name}</p>
                            <p><strong>Тип:</strong> ${getPropertyTypeText(property.type)}</p>
                            <p><strong>Адрес:</strong> ${property.address}</p>
                            <p><strong>Общая площадь:</strong> ${property.totalArea} м²</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Сдаваемая площадь:</strong> ${property.rentedArea} м²</p>
                            <p><strong>Общее потребление э/э:</strong> ${property.commonElectricity} кВт/ч</p>
                            <p><strong>Общее потребление газа:</strong> ${property.commonGas} м³</p>
                            <p><strong>Арендаторов:</strong> ${tenantsInProperty.length} (${activeTenants.length} активных)</p>
                        </div>
                    </div>
                    ${property.description ? `<p><strong>Описание:</strong> ${property.description}</p>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            `;
            
            showCustomModal(modalContent);
        }

        // Функции для работы с арендаторами
        function saveTenant() {
            const form = document.getElementById('addTenantForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const electricityRateInput = document.getElementById('tenantElectricityRate').value;
            const propertyId = parseInt(document.getElementById('tenantProperty').value);
            const status = document.getElementById('tenantStatus').value;
            
            if (currentEditId) {
                // Редактирование существующего арендатора
                updateTenant(currentEditId);
            } else {
                // Добавление нового арендатора
                const newTenant = {
                    id: appData.tenants.length > 0 ? Math.max(...appData.tenants.map(t => t.id)) + 1 : 1,
                    name: document.getElementById('tenantName').value,
                    business: document.getElementById('tenantBusiness').value,
                    propertyId: propertyId,
                    area: parseFloat(document.getElementById('tenantArea').value),
                    contract: document.getElementById('tenantContract').value,
                    contractDate: document.getElementById('contractDate').value,
                    phone: document.getElementById('tenantPhone').value,
                    email: document.getElementById('tenantEmail').value,
                    status: status,
                    electricityRate: electricityRateInput ? parseFloat(electricityRateInput) : null,
                    description: document.getElementById('tenantDescription').value
                };
                
                // Проверка на дубликаты
                const existingTenant = appData.tenants.find(t => 
                    t.name === newTenant.name && t.contract === newTenant.contract);
                
                if (existingTenant) {
                    alert('Арендатор с таким именем и номером договора уже существует');
                    return;
                }
                
                appData.tenants.push(newTenant);
                saveData();
                populateTenantsTable();
                populateSelects();
                
                // Сбросить ID редактирования
                currentEditId = null;
                
                // Закрыть модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTenantModal'));
                modal.hide();
            }
        }

        function editTenant(id) {
            const tenant = appData.tenants.find(t => t.id === id);
            if (!tenant) return;
            
            currentEditId = id;
            
            // Заполнить форму данными арендатора
            document.getElementById('tenantName').value = tenant.name;
            document.getElementById('tenantBusiness').value = tenant.business || '';
            document.getElementById('tenantProperty').value = tenant.propertyId;
            document.getElementById('tenantArea').value = tenant.area;
            document.getElementById('tenantContract').value = tenant.contract;
            document.getElementById('contractDate').value = tenant.contractDate;
            document.getElementById('tenantPhone').value = tenant.phone;
            document.getElementById('tenantEmail').value = tenant.email;
            document.getElementById('tenantStatus').value = tenant.status;
            document.getElementById('tenantElectricityRate').value = tenant.electricityRate || '';
            document.getElementById('tenantDescription').value = tenant.description;
            
            // Показать модальное окно
            const modal = new bootstrap.Modal(document.getElementById('addTenantModal'));
            modal.show();
            
            // Изменить заголовок
            document.getElementById('addTenantModalLabel').textContent = 'Редактировать арендатора';
        }

        function updateTenant(id) {
            const form = document.getElementById('addTenantForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const tenantIndex = appData.tenants.findIndex(t => t.id === id);
            if (tenantIndex === -1) return;
            
            const electricityRateInput = document.getElementById('tenantElectricityRate').value;
            const propertyId = parseInt(document.getElementById('tenantProperty').value);
            const status = document.getElementById('tenantStatus').value;
            
            appData.tenants[tenantIndex] = {
                ...appData.tenants[tenantIndex],
                name: document.getElementById('tenantName').value,
                business: document.getElementById('tenantBusiness').value,
                propertyId: propertyId,
                area: parseFloat(document.getElementById('tenantArea').value),
                contract: document.getElementById('tenantContract').value,
                contractDate: document.getElementById('contractDate').value,
                phone: document.getElementById('tenantPhone').value,
                email: document.getElementById('tenantEmail').value,
                status: status,
                electricityRate: electricityRateInput ? parseFloat(electricityRateInput) : null,
                description: document.getElementById('tenantDescription').value
            };
            
            saveData();
            populateTenantsTable();
            populateSelects();
            
            // Закрыть модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTenantModal'));
            modal.hide();
            
            // Сбросить ID редактирования
            currentEditId = null;
        }

        function deleteTenant(id) {
            if (confirm('Вы уверены, что хотите удалить этого арендатора?')) {
                appData.tenants = appData.tenants.filter(t => t.id !== id);
                saveData();
                populateTenantsTable();
                populateSelects();
            }
        }

        function viewTenant(id) {
            const tenant = appData.tenants.find(t => t.id === id);
            if (!tenant) return;
            
            const property = appData.properties.find(p => p.id === tenant.propertyId);
            const propertyName = property ? property.name : 'Не указан';
            
            const modalContent = `
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр арендатора</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ФИО / Название:</strong> ${tenant.name}</p>
                            <p><strong>Вид деятельности:</strong> ${tenant.business || 'Не указано'}</p>
                            <p><strong>Объект:</strong> ${propertyName}</p>
                            <p><strong>Площадь:</strong> ${tenant.area} м²</p>
                            <p><strong>Договор:</strong> ${tenant.contract}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Дата договора:</strong> ${formatDate(tenant.contractDate)}</p>
                            <p><strong>Телефон:</strong> ${tenant.phone || 'Не указан'}</p>
                            <p><strong>Email:</strong> ${tenant.email || 'Не указан'}</p>
                            <p><strong>Статус:</strong> ${getTenantStatusText(tenant.status)}</p>
                        </div>
                    </div>
                    ${tenant.description ? `<p><strong>Примечания:</strong> ${tenant.description}</p>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            `;
            
            showCustomModal(modalContent);
        }

        // Функции для работы с показаниями счетчиков
        function saveMeterReading() {
            const form = document.getElementById('addMeterReadingForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const tenantId = parseInt(document.getElementById('meterReadingTenant').value);
            const period = document.getElementById('meterReadingPeriod').value;
            
            if (currentEditId) {
                // Редактирование существующих показаний
                updateMeterReading(currentEditId);
            } else {
                // Проверить, есть ли уже показания для этого арендатора за этот период
                const existingReadingIndex = appData.meterReadings.findIndex(r => 
                    r.tenantId === tenantId && r.period === period);
                
                const newReading = {
                    id: existingReadingIndex !== -1 ? appData.meterReadings[existingReadingIndex].id : 
                        (appData.meterReadings.length > 0 ? Math.max(...appData.meterReadings.map(r => r.id)) + 1 : 1),
                    tenantId: tenantId,
                    period: period,
                    electricity: parseFloat(document.getElementById('electricityReading').value),
                    gas: document.getElementById('gasReading').value ? parseFloat(document.getElementById('gasReading').value) : null,
                    water: document.getElementById('waterReading').value ? parseFloat(document.getElementById('waterReading').value) : null,
                    date: document.getElementById('readingDate').value
                };
                
                if (existingReadingIndex !== -1) {
                    // Обновить существующие показания
                    appData.meterReadings[existingReadingIndex] = newReading;
                } else {
                    // Добавить новые показания
                    appData.meterReadings.push(newReading);
                }
                
                saveData();
                populateMeterReadingsTable();
                
                // Сбросить ID редактирования
                currentEditId = null;
                
                // Закрыть модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMeterReadingModal'));
                modal.hide();
            }
        }

        function editMeterReading(id) {
            const reading = appData.meterReadings.find(r => r.id === id);
            if (!reading) return;
            
            currentEditId = id;
            
            // Заполнить форму данными показаний
            document.getElementById('meterReadingTenant').value = reading.tenantId;
            document.getElementById('meterReadingPeriod').value = reading.period;
            document.getElementById('electricityReading').value = reading.electricity || '';
            document.getElementById('gasReading').value = reading.gas || '';
            document.getElementById('waterReading').value = reading.water || '';
            document.getElementById('readingDate').value = reading.date;
            
            // Показать модальное окно
            const modal = new bootstrap.Modal(document.getElementById('addMeterReadingModal'));
            modal.show();
            
            // Изменить заголовок
            document.getElementById('addMeterReadingModalLabel').textContent = 'Редактировать показания';
        }

        function updateMeterReading(id) {
            const form = document.getElementById('addMeterReadingForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const readingIndex = appData.meterReadings.findIndex(r => r.id === id);
            if (readingIndex === -1) return;
            
            appData.meterReadings[readingIndex] = {
                ...appData.meterReadings[readingIndex],
                tenantId: parseInt(document.getElementById('meterReadingTenant').value),
                period: document.getElementById('meterReadingPeriod').value,
                electricity: parseFloat(document.getElementById('electricityReading').value),
                gas: document.getElementById('gasReading').value ? parseFloat(document.getElementById('gasReading').value) : null,
                water: document.getElementById('waterReading').value ? parseFloat(document.getElementById('waterReading').value) : null,
                date: document.getElementById('readingDate').value
            };
            
            saveData();
            populateMeterReadingsTable();
            
            // Закрыть модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addMeterReadingModal'));
            modal.hide();
            
            // Сбросить ID редактирования
            currentEditId = null;
        }

        function deleteMeterReading(id) {
            if (confirm('Вы уверены, что хотите удалить эти показания?')) {
                appData.meterReadings = appData.meterReadings.filter(r => r.id !== id);
                saveData();
                populateMeterReadingsTable();
            }
        }

        function viewMeterReading(id) {
            const reading = appData.meterReadings.find(r => r.id === id);
            if (!reading) return;
            
            const tenant = appData.tenants.find(t => t.id === reading.tenantId);
            const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
            const propertyName = property ? property.name : 'Не указан';
            
            const modalContent = `
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр показаний счетчиков</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Арендатор:</strong> ${tenant ? tenant.name : 'Неизвестно'}</p>
                            <p><strong>Объект:</strong> ${propertyName}</p>
                            <p><strong>Период:</strong> ${formatPeriod(reading.period)}</p>
                            <p><strong>Дата снятия:</strong> ${formatDate(reading.date)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Электричество:</strong> ${reading.electricity || '-'} кВт/ч</p>
                            <p><strong>Газ:</strong> ${reading.gas || '-'} м³</p>
                            <p><strong>Вода:</strong> ${reading.water || '-'} м³</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            `;
            
            showCustomModal(modalContent);
        }

        // Функции для работы с расчетами платежей
        function calculateBilling() {
            const period = document.getElementById('billingPeriod').value;
            const includeAll = document.getElementById('includeAllTenants').checked;
            const specificTenant = document.getElementById('billingTenant').value;
            const notes = document.getElementById('billingNotes').value;
            
            if (!period) {
                alert('Пожалуйста, выберите период');
                return;
            }
            
            // Получаем общее потребление газа, если распределение по площади или объекту
            let totalGasConsumption = 0;
            let propertyForDistribution = null;
            
            if (appData.tariffs.gasDistribution === 'area' || appData.tariffs.gasDistribution === 'property') {
                totalGasConsumption = parseFloat(document.getElementById('totalGasConsumption').value);
                if (isNaN(totalGasConsumption) || totalGasConsumption < 0) {
                    alert('Пожалуйста, введите корректное общее потребление газа');
                    return;
                }
                
                if (appData.tariffs.gasDistribution === 'property') {
                    const propertyId = parseInt(document.getElementById('propertyForDistribution').value);
                    if (!propertyId) {
                        alert('Пожалуйста, выберите объект для распределения');
                        return;
                    }
                    propertyForDistribution = appData.properties.find(p => p.id === propertyId);
                }
            }
            
            const tenantsToBill = includeAll ? 
                appData.tenants.filter(t => t.status === 'active') : 
                appData.tenants.filter(t => t.id == specificTenant && t.status === 'active');
            
            if (tenantsToBill.length === 0) {
                alert('Нет активных арендаторов для расчета');
                return;
            }
            
            // Расчет платежей для каждого арендатора
            tenantsToBill.forEach(tenant => {
                // Найти последние показания счетчиков для этого арендатора
                const readings = appData.meterReadings
                    .filter(r => r.tenantId === tenant.id && r.period === period)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const latestReading = readings[0];
                
                if (!latestReading) {
                    alert(`Для арендатора ${tenant.name} нет показаний счетчиков за период ${period}`);
                    return;
                }
                
                // Определить тариф на электроэнергию
                const electricityRate = tenant.electricityRate !== null ? 
                    tenant.electricityRate : appData.tariffs.electricityRate;
                
                // Используем абсолютные показания
                const electricityConsumption = latestReading.electricity || 0;
                
                // Расчет сумм по тарифам
                const electricityAmount = electricityConsumption * electricityRate;
                
                // Расчет газа в зависимости от метода распределения
                let gasAmount = 0;
                if (appData.tariffs.gasDistribution === 'area') {
                    // Распределение по площади
                    const totalArea = tenantsToBill.reduce((sum, t) => sum + t.area, 0);
                    const tenantGasConsumption = (tenant.area / totalArea) * totalGasConsumption;
                    gasAmount = tenantGasConsumption * appData.tariffs.gasRate;
                } else if (appData.tariffs.gasDistribution === 'property') {
                    // Распределение по объекту
                    if (propertyForDistribution) {
                        const tenantsInProperty = appData.tenants.filter(t => 
                            t.propertyId === propertyForDistribution.id && t.status === 'active');
                        const totalAreaInProperty = tenantsInProperty.reduce((sum, t) => sum + t.area, 0);
                        const tenantGasConsumption = (tenant.area / totalAreaInProperty) * totalGasConsumption;
                        gasAmount = tenantGasConsumption * appData.tariffs.gasRate;
                    }
                } else {
                    // Индивидуальные счетчики
                    const gasConsumption = latestReading.gas ? latestReading.gas : 0;
                    gasAmount = gasConsumption * appData.tariffs.gasRate;
                }

                const waterAmount = latestReading.water ? 
                    latestReading.water * appData.tariffs.waterRate : 0;

                const garbageAmount = appData.tariffs.garbageRate;

                const maintenanceAmount = tenant.area * appData.tariffs.maintenanceRate;

                const totalAmount = electricityAmount + gasAmount + waterAmount + garbageAmount + maintenanceAmount;

                // Проверить, существует ли уже счет для этого арендатора и периода
                const existingBillIndex = appData.billing.findIndex(b => 
                    b.tenantId === tenant.id && b.period === period);

                if (existingBillIndex !== -1) {
                    // Обновить существующий счет
                    appData.billing[existingBillIndex] = {
                        ...appData.billing[existingBillIndex],
                        electricity: electricityAmount,
                        gas: gasAmount,
                        water: waterAmount,
                        garbage: garbageAmount,
                        maintenance: maintenanceAmount,
                        total: totalAmount,
                        notes: notes
                    };
                } else {
                    // Создать новый счет
                    const newBill = {
                        id: appData.billing.length > 0 ? Math.max(...appData.billing.map(b => b.id)) + 1 : 1,
                        period: period,
                        tenantId: tenant.id,
                        electricity: electricityAmount,
                        gas: gasAmount,
                        water: waterAmount,
                        garbage: garbageAmount,
                        maintenance: maintenanceAmount,
                        total: totalAmount,
                        status: 'unpaid',
                        notes: notes
                    };

                    appData.billing.push(newBill);
                }

                // Создать или обновить запись о платеже
                const existingPaymentIndex = appData.payments.findIndex(p => 
                    p.tenantId === tenant.id && p.period === period);

                if (existingPaymentIndex !== -1) {
                    // Обновить существующий платеж
                    const payment = appData.payments[existingPaymentIndex];
                    let status = 'unpaid';
                    if (payment.amount >= totalAmount) {
                        status = 'paid';
                    } else if (payment.amount > 0) {
                        status = 'partial';
                    }
                    
                    appData.payments[existingPaymentIndex] = {
                        ...payment,
                        status: status
                    };
                } else {
                    // Создать новый платеж
                    const newPayment = {
                        id: appData.payments.length > 0 ? Math.max(...appData.payments.map(p => p.id)) + 1 : 1,
                        tenantId: tenant.id,
                        period: period,
                        amount: 0,
                        date: '',
                        method: '',
                        notes: '',
                        status: 'unpaid'
                    };

                    appData.payments.push(newPayment);
                }
            });

            saveData();
            populateBillingTable();
            populatePaymentsTable();
            populatePaymentsHistoryTable();
            updateDashboardStats();

            // Закрыть модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('calculateBillingModal'));
            modal.hide();

            alert('Расчет платежей завершен');
        }

        function editBill(id) {
            const bill = appData.billing.find(b => b.id === id);
            if (!bill) return;
            
            currentEditId = id;
            
            const tenant = appData.tenants.find(t => t.id === bill.tenantId);
            
            // Заполнить форму данными счета
            document.getElementById('editBillPeriod').value = bill.period;
            document.getElementById('editBillTenant').value = tenant ? tenant.name : 'Неизвестно';
            document.getElementById('editBillElectricity').value = bill.electricity;
            document.getElementById('editBillGas').value = bill.gas;
            document.getElementById('editBillWater').value = bill.water;
            document.getElementById('editBillGarbage').value = bill.garbage;
            document.getElementById('editBillMaintenance').value = bill.maintenance;
            document.getElementById('editBillTotal').value = bill.total;
            document.getElementById('editBillStatus').value = bill.status;
            
            // Показать модальное окно
            const modal = new bootstrap.Modal(document.getElementById('editBillModal'));
            modal.show();
        }

        function saveEditBill() {
            const form = document.getElementById('editBillForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const billIndex = appData.billing.findIndex(b => b.id === currentEditId);
            if (billIndex === -1) return;
            
            appData.billing[billIndex] = {
                ...appData.billing[billIndex],
                electricity: parseFloat(document.getElementById('editBillElectricity').value),
                gas: parseFloat(document.getElementById('editBillGas').value),
                water: parseFloat(document.getElementById('editBillWater').value),
                garbage: parseFloat(document.getElementById('editBillGarbage').value),
                maintenance: parseFloat(document.getElementById('editBillMaintenance').value),
                total: parseFloat(document.getElementById('editBillTotal').value),
                status: document.getElementById('editBillStatus').value
            };
            
            saveData();
            populateBillingTable();
            populatePaymentsTable();
            populatePaymentsHistoryTable();
            updateDashboardStats();
            
            // Закрыть модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('editBillModal'));
            modal.hide();
            
            // Сбросить ID редактирования
            currentEditId = null;
        }

        function deleteBill(id) {
            if (confirm('Вы уверены, что хотите удалить этот счет?')) {
                appData.billing = appData.billing.filter(b => b.id !== id);
                saveData();
                populateBillingTable();
                updateDashboardStats();
            }
        }

        function viewBill(id) {
            const bill = appData.billing.find(b => b.id === id);
            if (!bill) return;
            
            const tenant = appData.tenants.find(t => t.id === bill.tenantId);
            const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
            const propertyName = property ? property.name : 'Не указан';
            
            const modalContent = `
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр счета</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Арендатор:</strong> ${tenant ? tenant.name : 'Неизвестно'}</p>
                            <p><strong>Объект:</strong> ${propertyName}</p>
                            <p><strong>Период:</strong> ${formatPeriod(bill.period)}</p>
                            <p><strong>Статус:</strong> ${getStatusText(bill.status)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Электричество:</strong> ${formatCurrency(bill.electricity)}</p>
                            <p><strong>Газ:</strong> ${formatCurrency(bill.gas)}</p>
                            <p><strong>Вода:</strong> ${formatCurrency(bill.water)}</p>
                            <p><strong>Вывоз мусора:</strong> ${formatCurrency(bill.garbage)}</p>
                            <p><strong>Обслуживание:</strong> ${formatCurrency(bill.maintenance)}</p>
                            <p><strong><h5>Итого:</h5></strong> <h5>${formatCurrency(bill.total)}</h5></p>
                        </div>
                    </div>
                    ${bill.notes ? `<p><strong>Примечания:</strong> ${bill.notes}</p>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            `;
            
            showCustomModal(modalContent);
        }

        // Функции для работы с платежами
        function savePayment() {
            const form = document.getElementById('addPaymentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const tenantId = parseInt(document.getElementById('paymentTenant').value);
            const period = document.getElementById('paymentPeriod').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (currentEditId) {
                // Редактирование существующего платежа
                updatePayment(currentEditId);
            } else {
                // Найти соответствующий счет
                const bill = appData.billing.find(b => 
                    b.tenantId === tenantId && b.period === period);
                
                if (!bill) {
                    alert('Для этого арендатора и периода нет счета. Сначала создайте расчет.');
                    return;
                }
                
                // Определить статус платежа
                let status = 'unpaid';
                if (amount >= bill.total) {
                    status = 'paid';
                } else if (amount > 0) {
                    status = 'partial';
                }
                
                // Проверить, существует ли уже платеж для этого арендатора и периода
                const existingPaymentIndex = appData.payments.findIndex(p => 
                    p.tenantId === tenantId && p.period === period);
                
                if (existingPaymentIndex !== -1) {
                    // Обновить существующий платеж
                    appData.payments[existingPaymentIndex] = {
                        ...appData.payments[existingPaymentIndex],
                        amount: amount,
                        date: date,
                        method: method,
                        notes: notes,
                        status: status
                    };
                    
                    // Обновить статус счета
                    bill.status = status;
                } else {
                    // Создать новый платеж
                    const newPayment = {
                        id: appData.payments.length > 0 ? Math.max(...appData.payments.map(p => p.id)) + 1 : 1,
                        tenantId: tenantId,
                        period: period,
                        amount: amount,
                        date: date,
                        method: method,
                        notes: notes,
                        status: status
                    };
                    
                    appData.payments.push(newPayment);
                    
                    // Обновить статус счета
                    bill.status = status;
                }
                
                saveData();
                populateBillingTable();
                populatePaymentsTable();
                populatePaymentsHistoryTable();
                updateDashboardStats();
                
                // Сбросить ID редактирования
                currentEditId = null;
                
                // Закрыть модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
                modal.hide();
            }
        }

        function editPayment(id) {
            const payment = appData.payments.find(p => p.id === id);
            if (!payment) return;
            
            currentEditId = id;
            
            // Заполнить форму данными платежа
            document.getElementById('paymentTenant').value = payment.tenantId;
            document.getElementById('paymentPeriod').value = payment.period;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentDate').value = payment.date;
            document.getElementById('paymentMethod').value = payment.method;
            document.getElementById('paymentNotes').value = payment.notes;
            
            // Показать модальное окно
            const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
            modal.show();
            
            // Изменить заголовок
            document.getElementById('addPaymentModalLabel').textContent = 'Редактировать платеж';
        }

        function updatePayment(id) {
            const form = document.getElementById('addPaymentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const paymentIndex = appData.payments.findIndex(p => p.id === id);
            if (paymentIndex === -1) return;
            
            const tenantId = parseInt(document.getElementById('paymentTenant').value);
            const period = document.getElementById('paymentPeriod').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;
            
            // Найти соответствующий счет
            const bill = appData.billing.find(b => 
                b.tenantId === tenantId && b.period === period);
            
            if (!bill) {
                alert('Для этого арендатора и периода нет счета. Сначала создайте расчет.');
                return;
            }
            
            // Определить статус платежа
            let status = 'unpaid';
            if (amount >= bill.total) {
                status = 'paid';
            } else if (amount > 0) {
                status = 'partial';
            }
            
            // Обновить платеж
            appData.payments[paymentIndex] = {
                ...appData.payments[paymentIndex],
                tenantId: tenantId,
                period: period,
                amount: amount,
                date: date,
                method: method,
                notes: notes,
                status: status
            };
            
            // Обновить статус счета
            bill.status = status;
            
            saveData();
            populateBillingTable();
            populatePaymentsTable();
            populatePaymentsHistoryTable();
            updateDashboardStats();
            
            // Закрыть модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
            modal.hide();
            
            // Сбросить ID редактирования
            currentEditId = null;
        }

        function deletePayment(id) {
            if (confirm('Вы уверены, что хотите удалить этот платеж?')) {
                const payment = appData.payments.find(p => p.id === id);
                if (payment) {
                    // Найти соответствующий счет и сбросить его статус
                    const bill = appData.billing.find(b => 
                        b.tenantId === payment.tenantId && b.period === payment.period);
                    
                    if (bill) {
                        bill.status = 'unpaid';
                    }
                }
                
                appData.payments = appData.payments.filter(p => p.id !== id);
                saveData();
                populateBillingTable();
                populatePaymentsTable();
                populatePaymentsHistoryTable();
                updateDashboardStats();
            }
        }

        function viewPayment(id) {
            const payment = appData.payments.find(p => p.id === id);
            if (!payment) return;
            
            const tenant = appData.tenants.find(t => t.id === payment.tenantId);
            const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
            const propertyName = property ? property.name : 'Не указан';
            
            const bill = appData.billing.find(b => b.tenantId === payment.tenantId && b.period === payment.period);
            const charged = bill ? bill.total : 0;
            const debt = charged - payment.amount;
            
            const modalContent = `
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр платежа</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Арендатор:</strong> ${tenant ? tenant.name : 'Неизвестно'}</p>
                            <p><strong>Объект:</strong> ${propertyName}</p>
                            <p><strong>Период:</strong> ${formatPeriod(payment.period)}</p>
                            <p><strong>Начислено:</strong> ${formatCurrency(charged)}</p>
                            <p><strong>Оплачено:</strong> ${formatCurrency(payment.amount)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Долг:</strong> ${formatCurrency(debt)}</p>
                            <p><strong>Статус:</strong> ${getStatusText(payment.status)}</p>
                            <p><strong>Дата оплаты:</strong> ${payment.date ? formatDate(payment.date) : '-'}</p>
                            <p><strong>Способ оплаты:</strong> ${getPaymentMethodText(payment.method)}</p>
                        </div>
                    </div>
                    ${payment.notes ? `<p><strong>Примечания:</strong> ${payment.notes}</p>` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            `;
            
            showCustomModal(modalContent);
        }

        // Сохранение тарифов
        function saveTariffs() {
            appData.tariffs = {
                electricityRate: parseFloat(document.getElementById('electricityRate').value),
                electricityNorm: parseFloat(document.getElementById('electricityNorm').value),
                gasRate: parseFloat(document.getElementById('gasRate').value),
                gasDistribution: document.getElementById('gasDistribution').value,
                waterRate: parseFloat(document.getElementById('waterRate').value),
                garbageRate: parseFloat(document.getElementById('garbageRate').value),
                maintenanceRate: parseFloat(document.getElementById('maintenanceRate').value)
            };
            
            saveData();
            alert('Тарифы успешно сохранены');
        }

        // Генерация отчета
        function generateReport() {
            const periodType = document.getElementById('reportPeriod').value;
            const reportType = document.getElementById('reportType').value;
            const propertyFilter = document.getElementById('reportProperty').value;
            
            let startDate, endDate;
            
            // Определение периода отчета
            if (periodType === 'custom') {
                startDate = document.getElementById('startDate').value;
                endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('Пожалуйста, выберите даты для произвольного периода');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('Дата начала не может быть позже даты окончания');
                    return;
                }
            } else {
                // Определение дат для стандартных периодов
                const now = new Date();
                switch (periodType) {
                    case 'current_month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
                        break;
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                        break;
                    case 'current_quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                        endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0).toISOString().split('T')[0];
                        break;
                    case 'last_quarter':
                        const lastQuarter = Math.floor((now.getMonth() / 3)) - 1;
                        const year = lastQuarter < 0 ? now.getFullYear() - 1 : now.getFullYear();
                        const adjustedQuarter = lastQuarter < 0 ? 3 : lastQuarter;
                        startDate = new Date(year, adjustedQuarter * 3, 1).toISOString().split('T')[0];
                        endDate = new Date(year, (adjustedQuarter + 1) * 3, 0).toISOString().split('T')[0];
                        break;
                    case 'current_year':
                        startDate = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                        endDate = new Date(now.getFullYear(), 11, 31).toISOString().split('T')[0];
                        break;
                }
            }
            
            // Фильтрация данных по периоду и объекту
            let filteredBilling = appData.billing.filter(bill => {
                const billDate = new Date(bill.period + '-01');
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // Фильтрация по объекту
                if (propertyFilter !== 'all') {
                    const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                    if (!tenant || tenant.propertyId != propertyFilter) {
                        return false;
                    }
                }
                
                return billDate >= start && billDate <= end;
            });
            
            let filteredPayments = appData.payments.filter(payment => {
                const paymentDate = new Date(payment.period + '-01');
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // Фильтрация по объекту
                if (propertyFilter !== 'all') {
                    const tenant = appData.tenants.find(t => t.id === payment.tenantId);
                    if (!tenant || tenant.propertyId != propertyFilter) {
                        return false;
                    }
                }
                
                return paymentDate >= start && paymentDate <= end;
            });
            
            // Генерация отчета в зависимости от типа
            let reportSummary = '';
            let reportDetails = '';
            
            switch (reportType) {
                case 'payments':
                    reportSummary = generatePaymentsReport(filteredBilling, filteredPayments, startDate, endDate);
                    reportDetails = generatePaymentsDetails(filteredBilling, filteredPayments);
                    break;
                case 'consumption':
                    reportSummary = generateConsumptionReport(filteredBilling, startDate, endDate);
                    reportDetails = generateConsumptionDetails(filteredBilling);
                    break;
                case 'debt':
                    reportSummary = generateDebtReport(filteredBilling, filteredPayments, startDate, endDate);
                    reportDetails = generateDebtDetails(filteredBilling, filteredPayments);
                    break;
                case 'comparison':
                    reportSummary = generateComparisonReport(filteredBilling, startDate, endDate);
                    reportDetails = generateComparisonDetails(filteredBilling);
                    break;
                case 'property':
                    reportSummary = generatePropertyReport(filteredBilling, filteredPayments, startDate, endDate);
                    reportDetails = generatePropertyDetails(filteredBilling, filteredPayments);
                    break;
            }
            
            // Обновление интерфейса
            document.getElementById('reportSummary').innerHTML = reportSummary;
            document.getElementById('reportDetailsTableBody').innerHTML = reportDetails;
        }

        // Вспомогательные функции для отчетов
        function generatePaymentsReport(billing, payments, startDate, endDate) {
            const totalBilled = billing.reduce((sum, bill) => sum + bill.total, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalDebt = totalBilled - totalPaid;
            
            return `
                <h6>Сводка по платежам</h6>
                <p><strong>Период:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>
                <p><strong>Начислено:</strong> ${formatCurrency(totalBilled)}</p>
                <p><strong>Оплачено:</strong> ${formatCurrency(totalPaid)}</p>
                <p><strong>Задолженность:</strong> ${formatCurrency(totalDebt)}</p>
                <p><strong>Процент оплаты:</strong> ${totalBilled > 0 ? Math.round((totalPaid / totalBilled) * 100) : 0}%</p>
            `;
        }

        function generatePaymentsDetails(billing, payments) {
            let detailsHTML = '';
            
            billing.forEach(bill => {
                const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
                const propertyName = property ? property.name : 'Не указан';
                
                const payment = payments.find(p => p.tenantId === bill.tenantId && p.period === bill.period);
                const paid = payment ? payment.amount : 0;
                const debt = bill.total - paid;
                
                detailsHTML += `
                    <tr>
                        <td>${tenant ? tenant.name : 'Неизвестно'}</td>
                        <td>${propertyName}</td>
                        <td>${formatPeriod(bill.period)}</td>
                        <td>${formatCurrency(bill.total)}</td>
                        <td>${formatCurrency(paid)}</td>
                        <td>${formatCurrency(debt)}</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            });
            
            return detailsHTML;
        }

        function generateConsumptionReport(billing, startDate, endDate) {
            const totalElectricity = billing.reduce((sum, bill) => sum + bill.electricity, 0);
            const totalGas = billing.reduce((sum, bill) => sum + bill.gas, 0);
            const totalWater = billing.reduce((sum, bill) => sum + bill.water, 0);
            
            return `
                <h6>Сводка по потреблению</h6>
                <p><strong>Период:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>
                <p><strong>Электроэнергия:</strong> ${formatCurrency(totalElectricity)}</p>
                <p><strong>Газ:</strong> ${formatCurrency(totalGas)}</p>
                <p><strong>Вода:</strong> ${formatCurrency(totalWater)}</p>
            `;
        }

        function generateConsumptionDetails(billing) {
            let detailsHTML = '';
            
            billing.forEach(bill => {
                const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
                const propertyName = property ? property.name : 'Не указан';
                
                detailsHTML += `
                    <tr>
                        <td>${tenant ? tenant.name : 'Неизвестно'}</td>
                        <td>${propertyName}</td>
                        <td>${formatPeriod(bill.period)}</td>
                        <td>${formatCurrency(bill.total)}</td>
                        <td>${formatCurrency(bill.electricity)}</td>
                        <td>${formatCurrency(bill.gas)}</td>
                        <td>${formatCurrency(bill.water)}</td>
                    </tr>
                `;
            });
            
            return detailsHTML;
        }

        function generateDebtReport(billing, payments, startDate, endDate) {
            const totalBilled = billing.reduce((sum, bill) => sum + bill.total, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalDebt = totalBilled - totalPaid;
            
            const debtors = billing.filter(bill => {
                const payment = payments.find(p => p.tenantId === bill.tenantId && p.period === bill.period);
                const paid = payment ? payment.amount : 0;
                return bill.total > paid;
            });
            
            return `
                <h6>Сводка по задолженностям</h6>
                <p><strong>Период:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>
                <p><strong>Общая задолженность:</strong> ${formatCurrency(totalDebt)}</p>
                <p><strong>Количество должников:</strong> ${debtors.length}</p>
                <p><strong>Средняя задолженность:</strong> ${formatCurrency(debtors.length > 0 ? totalDebt / debtors.length : 0)}</p>
            `;
        }

        function generateDebtDetails(billing, payments) {
            let detailsHTML = '';
            
            billing.forEach(bill => {
                const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
                const propertyName = property ? property.name : 'Не указан';
                
                const payment = payments.find(p => p.tenantId === bill.tenantId && p.period === bill.period);
                const paid = payment ? payment.amount : 0;
                const debt = bill.total - paid;
                
                if (debt > 0) {
                    detailsHTML += `
                        <tr>
                            <td>${tenant ? tenant.name : 'Неизвестно'}</td>
                            <td>${propertyName}</td>
                            <td>${formatPeriod(bill.period)}</td>
                            <td>${formatCurrency(bill.total)}</td>
                            <td>${formatCurrency(paid)}</td>
                            <td>${formatCurrency(debt)}</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    `;
                }
            });
            
            return detailsHTML;
        }

        function generateComparisonReport(billing, startDate, endDate) {
            const totalByTenant = {};
            
            billing.forEach(bill => {
                if (!totalByTenant[bill.tenantId]) {
                    totalByTenant[bill.tenantId] = 0;
                }
                totalByTenant[bill.tenantId] += bill.total;
            });
            
            const tenantTotals = Object.entries(totalByTenant).map(([tenantId, total]) => {
                const tenant = appData.tenants.find(t => t.id == tenantId);
                return {
                    name: tenant ? tenant.name : 'Неизвестно',
                    total: total
                };
            });
            
            tenantTotals.sort((a, b) => b.total - a.total);
            
            let reportHTML = '<h6>Сравнительный анализ</h6>';
            reportHTML += `<p><strong>Период:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>`;
            
            if (tenantTotals.length > 0) {
                reportHTML += `
                    <p><strong>Наибольшие расходы:</strong> ${tenantTotals[0].name} (${formatCurrency(tenantTotals[0].total)})</p>
                    <p><strong>Наименьшие расходы:</strong> ${tenantTotals[tenantTotals.length-1].name} (${formatCurrency(tenantTotals[tenantTotals.length-1].total)})</p>
                    <p><strong>Средние расходы:</strong> ${formatCurrency(tenantTotals.reduce((sum, t) => sum + t.total, 0) / tenantTotals.length)}</p>
                `;
            } else {
                reportHTML += '<p>Нет данных для анализа</p>';
            }
            
            return reportHTML;
        }

        function generateComparisonDetails(billing) {
            const totalByTenant = {};
            
            billing.forEach(bill => {
                if (!totalByTenant[bill.tenantId]) {
                    totalByTenant[bill.tenantId] = {
                        total: 0,
                        electricity: 0,
                        gas: 0,
                        water: 0,
                        count: 0
                    };
                }
                totalByTenant[bill.tenantId].total += bill.total;
                totalByTenant[bill.tenantId].electricity += bill.electricity;
                totalByTenant[bill.tenantId].gas += bill.gas;
                totalByTenant[bill.tenantId].water += bill.water;
                totalByTenant[bill.tenantId].count++;
            });
            
            let detailsHTML = '';
            
            Object.entries(totalByTenant).forEach(([tenantId, data]) => {
                const tenant = appData.tenants.find(t => t.id == tenantId);
                const property = tenant ? appData.properties.find(p => p.id === tenant.propertyId) : null;
                const propertyName = property ? property.name : 'Не указан';
                
                const avgTotal = data.total / data.count;
                
                detailsHTML += `
                    <tr>
                        <td>${tenant ? tenant.name : 'Неизвестно'}</td>
                        <td>${propertyName}</td>
                        <td>${data.count} периодов</td>
                        <td>${formatCurrency(data.total)}</td>
                        <td>${formatCurrency(data.electricity)}</td>
                        <td>${formatCurrency(data.gas)}</td>
                        <td>${formatCurrency(data.water)}</td>
                        <td>${formatCurrency(avgTotal)}</td>
                    </tr>
                `;
            });
            
            return detailsHTML;
        }

        function generatePropertyReport(billing, payments, startDate, endDate) {
            const totalByProperty = {};
            
            billing.forEach(bill => {
                const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                if (!tenant) return;
                
                const propertyId = tenant.propertyId;
                if (!totalByProperty[propertyId]) {
                    totalByProperty[propertyId] = {
                        totalBilled: 0,
                        totalPaid: 0,
                        count: 0
                    };
                }
                
                totalByProperty[propertyId].totalBilled += bill.total;
                totalByProperty[propertyId].count++;
                
                const payment = payments.find(p => p.tenantId === bill.tenantId && p.period === bill.period);
                if (payment) {
                    totalByProperty[propertyId].totalPaid += payment.amount;
                }
            });
            
            let reportHTML = '<h6>Сводка по объектам</h6>';
            reportHTML += `<p><strong>Период:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>`;
            
            Object.entries(totalByProperty).forEach(([propertyId, data]) => {
                const property = appData.properties.find(p => p.id == propertyId);
                if (property) {
                    const debt = data.totalBilled - data.totalPaid;
                    const paymentPercentage = data.totalBilled > 0 ? Math.round((data.totalPaid / data.totalBilled) * 100) : 0;
                    
                    reportHTML += `
                        <p><strong>${property.name}:</strong></p>
                        <p style="margin-left: 20px;">Начислено: ${formatCurrency(data.totalBilled)}</p>
                        <p style="margin-left: 20px;">Оплачено: ${formatCurrency(data.totalPaid)}</p>
                        <p style="margin-left: 20px;">Задолженность: ${formatCurrency(debt)}</p>
                        <p style="margin-left: 20px;">Процент оплаты: ${paymentPercentage}%</p>
                    `;
                }
            });
            
            return reportHTML;
        }

        function generatePropertyDetails(billing, payments) {
            const groupedByProperty = {};
            
            billing.forEach(bill => {
                const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                if (!tenant) return;
                
                const propertyId = tenant.propertyId;
                if (!groupedByProperty[propertyId]) {
                    groupedByProperty[propertyId] = [];
                }
                
                groupedByProperty[propertyId].push(bill);
            });
            
            let detailsHTML = '';
            
            Object.entries(groupedByProperty).forEach(([propertyId, bills]) => {
                const property = appData.properties.find(p => p.id == propertyId);
                if (property) {
                    detailsHTML += `
                        <tr>
                            <td colspan="8" class="table-active fw-bold">${property.name}</td>
                        </tr>
                    `;
                    
                    bills.forEach(bill => {
                        const tenant = appData.tenants.find(t => t.id === bill.tenantId);
                        const payment = payments.find(p => p.tenantId === bill.tenantId && p.period === bill.period);
                        const paid = payment ? payment.amount : 0;
                        const debt = bill.total - paid;
                        
                        detailsHTML += `
                            <tr>
                                <td>${tenant ? tenant.name : 'Неизвестно'}</td>
                                <td>${property.name}</td>
                                <td>${formatPeriod(bill.period)}</td>
                                <td>${formatCurrency(bill.total)}</td>
                                <td>${formatCurrency(paid)}</td>
                                <td>${formatCurrency(debt)}</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        `;
                    });
                }
            });
            
            return detailsHTML;
        }

        // Экспорт данных
        function exportSection(sectionId) {
            let data = [];
            let filename = '';
            
            switch (sectionId) {
                case 'dashboard':
                    data = appData.payments.slice(0, 5);
                    filename = 'dashboard_payments';
                    break;
                case 'properties':
                    data = appData.properties;
                    filename = 'properties';
                    break;
                case 'tenants':
                    data = appData.tenants;
                    filename = 'tenants';
                    break;
                case 'meter-readings':
                    data = appData.meterReadings;
                    filename = 'meter_readings';
                    break;
                case 'billing':
                    data = appData.billing;
                    filename = 'billing';
                    break;
                case 'payments':
                    data = appData.payments;
                    filename = 'payments';
                    break;
                case 'reports':
                    // Экспорт текущего отчета
                    const reportType = document.getElementById('reportType').value;
                    const periodType = document.getElementById('reportPeriod').value;
                    data = {
                        reportType: reportType,
                        period: periodType,
                        generated: new Date().toISOString(),
                        data: getReportDataForExport(reportType, periodType)
                    };
                    filename = 'report';
                    break;
            }
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Данные экспортированы');
        }

        function getReportDataForExport(reportType, periodType) {
            // Фильтрация данных по периоду
            let filteredBilling = appData.billing;
            let filteredPayments = appData.payments;
            
            if (periodType !== 'all') {
                const now = new Date();
                let startDate, endDate;
                
                switch (periodType) {
                    case 'current_month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        break;
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                        break;
                    case 'current_quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                        endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                        break;
                    case 'last_quarter':
                        const lastQuarter = Math.floor(now.getMonth() / 3) - 1;
                        startDate = new Date(now.getFullYear(), lastQuarter * 3, 1);
                        endDate = new Date(now.getFullYear(), (lastQuarter + 1) * 3, 0);
                        break;
                    case 'current_year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                        break;
                }
                
                startDate = startDate.toISOString().split('T')[0];
                endDate = endDate.toISOString().split('T')[0];
                
                filteredBilling = appData.billing.filter(bill => {
                    const billDate = new Date(bill.period + '-01');
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return billDate >= start && billDate <= end;
                });
                
                filteredPayments = appData.payments.filter(payment => {
                    const paymentDate = new Date(payment.period + '-01');
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return paymentDate >= start && paymentDate <= end;
                });
            }
            
            // Подготовка данных для экспорта в зависимости от типа отчета
            switch (reportType) {
                case 'payments':
                    return {
                        billing: filteredBilling,
                        payments: filteredPayments
                    };
                case 'consumption':
                    return {
                        billing: filteredBilling
                    };
                case 'debt':
                    return {
                        billing: filteredBilling,
                        payments: filteredPayments
                    };
                case 'comparison':
                    return {
                        billing: filteredBilling
                    };
                case 'property':
                    return {
                        properties: appData.properties,
                        billing: filteredBilling,
                        payments: filteredPayments
                    };
                default:
                    return {
                        billing: filteredBilling,
                        payments: filteredPayments
                    };
            }
        }

        // Печать данных
        function printSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Печать ${getSectionTitle(sectionId)}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; }
                        @media print {
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <h2>${getSectionTitle(sectionId)}</h2>
                    <p>Сформировано: ${new Date().toLocaleString()}</p>
                    ${section.innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function getSectionTitle(sectionId) {
            const titles = {
                'dashboard': 'Панель управления',
                'properties': 'Объекты недвижимости',
                'tenants': 'Арендаторы',
                'meter-readings': 'Показания счетчиков',
                'billing': 'Расчеты платежей',
                'payments': 'Платежи',
                'reports': 'Отчеты'
            };
            
            return titles[sectionId] || 'Документ';
        }

        // Обновление статистики на дашборде
        function updateDashboardStats() {
            // Общая сумма платежей
            const totalPayments = appData.payments.reduce((sum, payment) => sum + payment.amount, 0);
            document.getElementById('totalPayments').textContent = formatCurrency(totalPayments);
            
            // Общее потребление электроэнергии
            const totalElectricity = appData.meterReadings.reduce((sum, reading) => sum + (reading.electricity || 0), 0);
            document.getElementById('totalElectricity').textContent = `${totalElectricity.toLocaleString()} кВт/ч`;
            
            // Общее потребление газа
            const totalGas = appData.meterReadings.reduce((sum, reading) => sum + (reading.gas || 0), 0);
            document.getElementById('totalGas').textContent = `${totalGas.toLocaleString()} м³`;
            
            // Процент оплаченных счетов
            const paidBills = appData.billing.filter(bill => bill.status === 'paid').length;
            const totalBills = appData.billing.length;
            const paidPercentage = totalBills > 0 ? Math.round((paidBills / totalBills) * 100) : 0;
            document.getElementById('paidPercentage').textContent = `${paidPercentage}%`;
            
            // Обновляем графики
            initCharts();
        }

        // Вспомогательные функции
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', { 
                style: 'currency', 
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }

        function formatPeriod(period) {
            if (!period) return '-';
            const [year, month] = period.split('-');
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function getStatusText(status) {
            const statuses = {
                'paid': 'Оплачено',
                'partial': 'Частично оплачено',
                'unpaid': 'Не оплачено'
            };
            return statuses[status] || status;
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cash': 'Наличные',
                'bank_transfer': 'Банковский перевод',
                'card': 'Карта',
                'online': 'Онлайн'
            };
            return methods[method] || method;
        }

        function getPropertyTypeText(type) {
            const types = {
                'residential': 'Жилой дом',
                'commercial': 'Коммерческое здание',
                'mixed': 'Смешанного типа',
                'other': 'Другое'
            };
            return types[type] || type;
        }

        function getTenantStatusText(status) {
            const statuses = {
                'active': 'Активный',
                'inactive': 'Неактивный',
                'suspended': 'Приостановлен'
            };
            return statuses[status] || status;
        }

        function showCustomModal(content) {
            // Создать модальное окно
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal fade';
            modalDiv.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalDiv);
            
            const modal = new bootstrap.Modal(modalDiv);
            modal.show();
            
            // Удалить модальное окно после закрытия
            modalDiv.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modalDiv);
            });
        }

        // Инициализация при загрузке
        window.onload = function() {
            console.log('Window loaded, checking for sample data...');
            
            // Проверить, есть ли данные в localStorage
            const savedData = localStorage.getItem('utilityBillingData');
            if (!savedData) {
                // Если данных нет, инициализировать пример данных
                console.log('No data found, initializing sample data...');
                initializeSampleData();
            } else {
                console.log('Found existing data, loading...');
            }
        };
    </script>
</body>
</html>